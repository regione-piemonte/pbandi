<pbandi-master-spinner *ngIf="spinner"></pbandi-master-spinner> <!-- subText="Caricamento..."-->
<div class="page" [ngClass]="{'displayNone': spinner}" id="scrollId">
  
    <div class="title">
      <h2>Monitoraggio Crediti</h2>
    </div>

    <div class="content">
      
      <mat-card class="mat-elevation-z2 messageError" *ngIf="isMessageErrorVisible">
        <mat-card-content class="messageErrorContent">
          <p [innerHTML]="messageError"></p>
        </mat-card-content>
      </mat-card>


      <mat-expansion-panel [expanded]="criteriRicercaState" (opened)="criteriRicercaState = true" (closed)="criteriRicercaState = false" hideToggle>
          <mat-expansion-panel-header style="padding-top: 10px; padding-bottom: 10px;">
              <div class="header">
                  <h3 class="search" style="display: flex; align-items: center;">Criteri di ricerca
                    <mat-icon class="arrow" style="padding-left: 7px;" *ngIf="criteriRicercaState">expand_less</mat-icon>
                    <mat-icon class="arrow" style="padding-left: 7px;" *ngIf="!criteriRicercaState">expand_more</mat-icon>
                  </h3>
              </div>
          </mat-expansion-panel-header>

          <div>
            <form [formGroup]="myForm">

              <mat-grid-list cols="8" rowHeight="60px">
                <mat-grid-tile [colspan]="4" [rowspan]="1">
                  <div class="fullWidth">
                    <mat-form-field class="elem1" appearance="standard">
                      <mat-label>Codice Fiscale</mat-label>
                      <input matInput type="text" formControlName="codiceFiscale" [matAutocomplete]="auto1">
                      <button type="button" *ngIf="myForm.get('codiceFiscale').value" matSuffix mat-icon-button (click)="myForm.get('codiceFiscale').setValue('')">
                        <mat-icon>close</mat-icon>
                      </button>
                      <mat-autocomplete #auto1="matAutocomplete" autoActiveFirstOption>
                        <!-- Mostra il messaggio di "Caricamento..." mentre attendo la risposta dal server -->
                        <mat-option *ngIf="loadingSuggestions" class="loading-option" [disabled]="true">
                          Caricamento...
                        </mat-option>
                        <!-- Mostra i suggerimenti normali -->
                        <mat-option *ngFor="let option of suggCodFis | async" [value]="option">
                          {{option}}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </div>
                </mat-grid-tile>

                <mat-grid-tile [colspan]="4" [rowspan]="1">
                  <div class="fullWidth">
                    <mat-form-field class="elem1" appearance="standard">
                      <mat-label>NDG</mat-label>
                      <input matInput formControlName="nag" [matAutocomplete]="auto2">
                      <button type="button" *ngIf="myForm.get('nag').value" matSuffix mat-icon-button (click)="myForm.get('nag').setValue('')">
                        <mat-icon>close</mat-icon>
                      </button>
                      <mat-autocomplete #auto2="matAutocomplete" autoActiveFirstOption>
                        <!-- Mostra il messaggio di "Caricamento..." mentre attendo la risposta dal server -->
                        <mat-option *ngIf="loadingSuggestions" class="loading-option" [disabled]="true">
                          Caricamento...
                        </mat-option>
                        <!-- Mostra i suggerimenti normali -->
                        <mat-option *ngFor="let option of suggNag | async" [value]="option">
                          {{option}}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </div>
                </mat-grid-tile>

                <mat-grid-tile [colspan]="4" [rowspan]="1">
                  <div class="fullWidth">
                    <mat-form-field class="elem1" appearance="standard">
                      <mat-label>Partita IVA</mat-label>
                      <input matInput formControlName="partitaIva" [matAutocomplete]="auto3">
                      <button type="button" *ngIf="myForm.get('partitaIva').value" matSuffix mat-icon-button (click)="myForm.get('partitaIva').setValue('')">
                        <mat-icon>close</mat-icon>
                      </button>
                      <mat-autocomplete #auto3="matAutocomplete" autoActiveFirstOption>
                        <!-- Mostra il messaggio di "Caricamento..." mentre attendo la risposta dal server -->
                        <mat-option *ngIf="loadingSuggestions" class="loading-option" [disabled]="true">
                          Caricamento...
                        </mat-option>
                        <!-- Mostra i suggerimenti normali -->
                        <mat-option *ngFor="let option of suggPartIva | async" [value]="option">
                          {{option}}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </div>
                </mat-grid-tile>

                <mat-grid-tile [colspan]="4" [rowspan]="1">
                  <div class="fullWidth">
                    <mat-form-field class="elem1" appearance="standard">
                      <mat-label>Denominazione / Cognome e Nome</mat-label>
                      <input matInput formControlName="denominazione" [matAutocomplete]="auto4">
                      <button type="button" *ngIf="myForm.get('denominazione').value" matSuffix mat-icon-button (click)="myForm.get('denominazione').setValue('')">
                        <mat-icon>close</mat-icon>
                      </button>
                      <mat-autocomplete #auto4="matAutocomplete" autoActiveFirstOption>
                        <!-- Mostra il messaggio di "Caricamento..." mentre attendo la risposta dal server -->
                        <mat-option *ngIf="loadingSuggestions" class="loading-option" [disabled]="true">
                          Caricamento...
                        </mat-option>
                        <!-- Mostra i suggerimenti normali -->
                        <mat-option *ngFor="let option of suggDenom | async" [value]="option">
                          {{option}}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </div>
                </mat-grid-tile>

                <mat-grid-tile [colspan]="4" [rowspan]="1">
                  <div class="fullWidth">
                    <mat-form-field class="elem1" appearance="standard">
                      <mat-label>Descrizione Bando</mat-label>
                      <input matInput formControlName="descBando" [matAutocomplete]="auto5">
                      <button type="button" *ngIf="myForm.get('descBando').value" matSuffix mat-icon-button (click)="myForm.get('descBando').setValue('')">
                        <mat-icon>close</mat-icon>
                      </button>
                      <mat-autocomplete #auto5="matAutocomplete" autoActiveFirstOption>
                        <!-- Mostra il messaggio di "Caricamento..." mentre attendo la risposta dal server -->
                        <mat-option *ngIf="loadingSuggestions" class="loading-option" [disabled]="true">
                          Caricamento...
                        </mat-option>
                        <!-- Mostra i suggerimenti normali -->
                        <mat-option *ngFor="let option of suggDescBan | async" [value]="option">
                          {{option}}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </div>
                </mat-grid-tile>

                <mat-grid-tile [colspan]="4" [rowspan]="1">
                  <div class="fullWidth">
                    <mat-form-field class="elem1" appearance="standard">
                      <mat-label>Codice progetto</mat-label>
                      <input matInput formControlName="codiceProgetto" [matAutocomplete]="auto6">
                      <button type="button" *ngIf="myForm.get('codiceProgetto').value" matSuffix mat-icon-button (click)="myForm.get('codiceProgetto').setValue('')">
                        <mat-icon>close</mat-icon>
                      </button>
                      <mat-autocomplete #auto6="matAutocomplete" autoActiveFirstOption>
                        <!-- Mostra il messaggio di "Caricamento..." mentre attendo la risposta dal server -->
                        <mat-option *ngIf="loadingSuggestions" class="loading-option" [disabled]="true">
                          Caricamento...
                        </mat-option>
                        <!-- Mostra i suggerimenti normali -->
                        <mat-option *ngFor="let option of suggCodPro | async" [value]="option">
                          {{option}}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </div>
                </mat-grid-tile>
              </mat-grid-list>
              <br>
              <!--<div style="display: flex; justify-content: end;">  </div>-->
              <button mat-raised-button class="button-style-2" (click)="search()">CERCA</button>
              <button mat-button type="button" class="button-style-1" (click)="reset()" style="margin-left: 10px;">RESET</button>
            </form>
          </div>
        </mat-expansion-panel>
    </div>


    <div class="content">
      <mat-card class="result-table" [ngClass]="{'displayNone': !showResults }"> <!--class="marty-card"-->
        <mat-card-title>
          <h3>Risultati di ricerca</h3>
        </mat-card-title>
        <mat-card-content class="scrollable-content">
          <p *ngIf="!fin || !fin.length"><b>Non ci sono elementi da visualizzare per i criteri selezionati.</b></p>
          
          <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="tab"
            [ngClass]="{'displayNone': !fin || !fin.length }" matSort>

            <!--<ng-container matColumnDef="leftActions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element">
                <div>
                  <button mat-icon-button (click)="expandedElement = expandedElement === element ? null : element">
                    <mat-icon *ngIf="expandedElement != element">visibility</mat-icon>
                    <mat-icon *ngIf="expandedElement == element">visibility_off</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>-->

            <ng-container matColumnDef="ndg">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>NDG</th>
              <td mat-cell *matCellDef="let element"> {{element.ndg === null ? "-" : element.ndg}} </td>
            </ng-container>

            <ng-container matColumnDef="denominazione">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Denominazione</th>
              <td mat-cell *matCellDef="let element"> {{element.denominazione === null ? "-" : element.denominazione}} </td>
            </ng-container>

            <ng-container matColumnDef="codiceFiscale">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Codice fiscale</th>
              <td mat-cell *matCellDef="let element">{{element.codiceFiscale === null ? "-" : element.codiceFiscale}} </td>
            </ng-container>

            <ng-container matColumnDef="partitaIva">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Partita iva</th>
              <td mat-cell *matCellDef="let element">{{element.partitaIva === null ? "-" : element.partitaIva}}</td>
            </ng-container>

            <ng-container matColumnDef="formaGiuridica">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Forma giuridica</th>
              <td mat-cell *matCellDef="let element"> {{element.formaGiuridica === null ? "-" : element.formaGiuridica}} </td>
            </ng-container>

            <ng-container matColumnDef="statoAzienda">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Stato azienda</th>
              <td mat-cell *matCellDef="let element">{{element.statoAzienda === null ? "-" : element.statoAzienda}}</td>
            </ng-container>

            <ng-container matColumnDef="rating">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Rating</th>
              <td mat-cell *matCellDef="let element">{{element.rating === null ? "-" : element.rating}}</td>
            </ng-container>

            <ng-container matColumnDef="dataProcedura">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Data procedura concorsuale</th> <!-- TODO: controllare per id e non per valore-->
              <td mat-cell *matCellDef="let element"> {{(element.statoAzienda=='Attiva' || element.statoAzienda=='Inattiva' || element.statoAzienda=='ND')? "-" : element.dataProcedura | date:'dd/MM/yyyy'}} </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element">
                <div>
                  <button mat-icon-button><!--(click)="expandedElement = expandedElement === element ? null : element"-->
                    <mat-icon inline *ngIf="expandedElement != element" class="font-size-large" matTooltip="Visualizza dettaglio agevolazioni">expand_more</mat-icon>
                    <mat-icon inline *ngIf="expandedElement == element" class="font-size-large" matTooltip="Nascondi dettaglio">expand_less</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="expandedDetail">
              <td mat-cell *matCellDef="let inElement" [attr.colspan]="displayedColumns.length" class="detalBoxRow">
                <div class="example-element-detail"
                  [@detailExpand]="inElement == expandedElement ? 'expanded' : 'collapsed'">

                  <table mat-table [dataSource]="inElement.listaDettagli" multiTemplateDataRows class="innerTable">

                    <!--<ng-container matColumnDef="chiaveMeccanica"> Era una chiave inglese ma vabé
                      <th mat-header-cell *matHeaderCellDef></th>
                      <td mat-cell *matCellDef="let element">
                        <div class="options">
                          <button mat-icon-button (click)="rowEdit(element)" >
                            <mat-icon matTooltip="Vai ad Attività Istruttore" matTooltipPosition="above">library_books</mat-icon>
                          </button>
                        </div>
                      </td>
                    </ng-container>-->

                    <ng-container matColumnDef="titoloBando">
                      <th mat-header-cell *matHeaderCellDef>Bando</th>
                      <td mat-cell *matCellDef="let element"><!--{{element.titoloBando === null ? "-" : element.titoloBando}}-->
                        <span [matTooltip]="element.titoloBando" [matTooltipDisabled]="element.titoloBando.length <= 30" matTooltipPosition="right">{{ element.titoloBando | slice:0:30 }}{{ element.titoloBando.length > 30 ? '...' : '' }}</span></td>
                    </ng-container>

                    <ng-container matColumnDef="codProgetto">
                      <th mat-header-cell *matHeaderCellDef>Progetto</th>
                      <td mat-cell *matCellDef="let element">
                        {{element.codProgetto === null ? "-" : element.codProgetto}}</td>
                    </ng-container>

                    <ng-container matColumnDef="modAgevolazione">
                      <th mat-header-cell *matHeaderCellDef><span matTooltip="Tipo Agevolazione">Tipo Agev.</span></th>
                      <td mat-cell *matCellDef="let element"><!--  {{resService.valorizzaAgevolazione(element.idModalitaAgevolazioneRif, element.descBreveModalitaAgevolazioneRif)}}-->
                        <span matTooltip="{{element.descModalitaAgevolazioneOrig}}" matTooltipPosition="right">{{element.dispDescAgevolazione == null ? '-' : element.dispDescAgevolazione}}</span>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="statoAgevolazione">
                      <th mat-header-cell *matHeaderCellDef><span matTooltip="Stato Agevolazione">Stato Agev.</span></th>><!--{{checkStatoAgevolazione(element)}}-->
                      <td mat-cell *matCellDef="let element">{{element.dispStatoAgevolazione == null ? '-' : element.dispStatoAgevolazione}}</td>
                    </ng-container>

                    <ng-container matColumnDef="statoCredito">
                      <th mat-header-cell *matHeaderCellDef>Stato credito</th>
                      <td mat-cell *matCellDef="let element">{{element.descStatoCredito}}</td>
                    </ng-container>
                    
                    <ng-container matColumnDef="statoCess">
                      <th mat-header-cell *matHeaderCellDef><span matTooltip="Stato cessione">Stato cessi.</span></th>
                      <td mat-cell *matCellDef="let element">{{(element.statoCessione === null || element.idModalitaAgevolazioneRif==10) ? "-" : element.statoCessione}}</td>
                    </ng-container>
                    
                    <ng-container matColumnDef="importoAmmesso">
                      <th mat-header-cell *matHeaderCellDef class="value-column">Importo ammesso</th>
                      <td mat-cell *matCellDef="let element" class="value-column"> 
                        {{element.importoAmmesso === null ? "-" : element.importoAmmesso | number: '1.2-2' : 'it'}}
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="totaleErogato">
                      <th mat-header-cell *matHeaderCellDef class="value-column"><span matTooltip="Importo concesso Finpiemonte">Importo concesso Finpiem.</span></th>
                      <td mat-cell *matCellDef="let element" class="value-column"> 
                        {{element.totaleErogato === null ? "-" : element.totaleErogato | number: '1.2-2' : 'it'}}
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="totaleErogatoFin">
                      <th mat-header-cell *matHeaderCellDef class="value-column"><span matTooltip="Totale erogato Finpiemonte">Totale erogato Finpiem.</span></th>
                      <td mat-cell *matCellDef="let element" class="value-column"> {{element.totaleErogatoFin === null ? "-" : element.totaleErogatoFin | number: '1.2-2' : 'it'}} </td>
                    </ng-container>

                    <ng-container matColumnDef="totaleErogatoBanca">
                      <th mat-header-cell *matHeaderCellDef class="value-column">Totale erogato Banca</th>
                      <td mat-cell *matCellDef="let element" class="value-column">{{element.totaleErogatoBanca === null || element.idModalitaAgevolazioneRif != 5 ? "-" : element.totaleErogatoBanca | number: '1.2-2' : 'it'}}</td>
                    </ng-container>

                    <ng-container matColumnDef="creditoResiduo">
                      <th mat-header-cell *matHeaderCellDef class="value-column">Credito residuo</th>
                      <td mat-cell *matCellDef="let element" class="value-column">
                        <ng-container *ngIf="element.isCreditoResiduoLoading; else data1Loaded">
                          <mat-spinner [diameter]="40"></mat-spinner>
                        </ng-container>
                        <ng-template #data1Loaded>
                          {{element.creditoResiduo === null ? "-" : element.creditoResiduo | number: '1.2-2' : 'it'}}
                        </ng-template>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="agevolazione">
                      <th mat-header-cell *matHeaderCellDef class="value-column"><span matTooltip="Agevolazione">Agev.</span></th>
                      <td mat-cell *matCellDef="let element" class="value-column">
                        <ng-container *ngIf="element.isAgevolazioneLoading; else data2Loaded">
                          <mat-spinner [diameter]="40"></mat-spinner>
                        </ng-container>
                        <ng-template #data2Loaded>
                          {{element.agevolazione === null ? "-" : element.agevolazione | number: '1.2-2' : 'it'}}
                        </ng-template>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="dataRevocaBancaria">
                      <th mat-header-cell *matHeaderCellDef><span matTooltip="Data revoca bancaria">Data rev. ban.</span></th>
                      <td mat-cell *matCellDef="let element"> {{element.dataRevocaBancaria === null ? "-" : element.dataRevocaBancaria | date:'dd/MM/yyyy'}} </td>
                    </ng-container>

                    <ng-container matColumnDef="revocaAmministrativa">
                      <th mat-header-cell *matHeaderCellDef><span matTooltip="Revoca amministrativa">Revoca amm.</span></th>
                      <td mat-cell *matCellDef="let element"> 
                        <div *ngIf="element.revocaAmministrativa == 'No'" style="padding-left: 22px">No</div>
                        <div *ngIf="element.revocaAmministrativa == 'Si'"><button mat-button style="padding: 0 0px;"
                        (click)="openRevDialog(element)" color="primary" matTooltip="Apri dettaglio Revoca Amministrativa"> <b> Si</b></button></div></td>
                    </ng-container>

                    <ng-container matColumnDef="libMandatoBanca">
                      <th mat-header-cell *matHeaderCellDef><span matTooltip="Liberazione mandato banca">Liberaz. mandato banca</span></th>
                      <td mat-cell *matCellDef="let element"> {{element.libMandatoBanca == null ? '-' : element.libMandatoBanca}} </td>
                    </ng-container>
                    
                    <ng-container matColumnDef="actions">
                      <th mat-header-cell *matHeaderCellDef></th>
                      <td mat-cell *matCellDef="let element">
                        <div class="options">
                          <!-- Se è contributo ed esiste una revoca - Se è finanziamento - Se è Garanzia -->
                          <button mat-icon-button *ngIf="(element.idModalitaAgevolazioneRif == '1' && element.revocaAmministrativa == 'Si') || element.idModalitaAgevolazioneRif == '5' || element.idModalitaAgevolazioneRif == '10'" (click)="openPianoAmmortamento(inElement, element)">
                            <mat-icon matTooltip="Apri Piano di Ammortamento">pending</mat-icon>
                          </button>
                          <!-- Se abbiamo più di un record nella PBANDI_T_EROGAZIONE per progetto e agevolazione -->
                          <button mat-icon-button *ngIf="element.numErogazioni > 0" (click)="openEstrattoConto(inElement, element)">
                            <mat-icon matTooltip="Apri Estratto Conto">receipt</mat-icon>
                          </button>
                          <button mat-icon-button (click)="rowEdit(element)" >
                            <mat-icon matTooltip="Vai ad Attività Istruttore">library_books</mat-icon>
                          </button>
                        </div>
                      </td>
                    </ng-container>


                    <tr mat-header-row *matHeaderRowDef="displayedInnerColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedInnerColumns;"></tr>
                  </table>

                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let element; columns: displayedColumns;" class="example-element-row"
            [class.example-expanded-row]="expandedElement === element"
            (click)="expandedElement = expandedElement === element ? null : element"></tr>
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>

          </table>

          <div class="bottom-options" [ngClass]="{'displayNone': !fin || !fin.length}">
            <button class="button-style-2 download-button-component" mat-button [disabled]="loadingFromAmmvo > 0" (click)="downloadExcel()"><span class="download-button-container">SCARICA EXCEL<mat-icon class="download-icon">save_alt</mat-icon></span></button>
            <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" [pageSize]="10" [showFirstLastButtons]="true"></mat-paginator>  <!-- [ngClass]="{'displayNone': !fin || !fin.length }"-->
          </div>
          
        </mat-card-content>
      </mat-card>
    </div>
</div>