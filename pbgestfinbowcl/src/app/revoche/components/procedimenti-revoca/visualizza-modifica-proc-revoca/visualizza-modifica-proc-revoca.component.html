<mat-spinner-pbandi class="page" *ngIf="isLoading"></mat-spinner-pbandi>
<div class="page" [ngClass]="{'displayNone': isLoading}" id="scrollId">
  <div class="title">
    <div class="backContainer">
      <button (click)="goBack()" mat-button>
        <mat-icon class="blue-icon">keyboard_backspace</mat-icon>
        <span class="backText">Torna alla ricerca</span>
      </button>
    </div>
    <h2>Modifica procedimento di revoca</h2>

    <div *ngIf="mostraErrori">
      <div [hidden]="!error">
        <div  class="content width-100-perc margin-0 max-width-89-perc">
          <mat-card  class="mat-card mat-focus-indicator messageError"
            >
            <mat-card-content  class="mat-card-content messageWarningContent"
              >
              <p  id="ellipsisP"
                class="white-space-nowrap text-overflow-ellipsis overflow-hidden">
                {{messageError}}
              </p>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <div [hidden]="!success">
        <div  class="content width-100-perc margin-0 max-width-89-perc">
          <mat-card  class="mat-card mat-focus-indicator messageSuccess"
            >
            <mat-card-content  class="mat-card-content messageWarningContent"
              >
              <p  id="ellipsisP"
                class="white-space-nowrap text-overflow-ellipsis overflow-hidden">
                {{messageSuccess}}
              </p>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </div>


  </div>


  <!-- CONTENT -->
  <div class="content">

    <!-- MAT CARD 1 -->
    <mat-card class="mat-elevation-z4 marginTop20">
      <mat-card-content class="mat-card-content">
        <div>Beneficiario:
          <strong>
            {{procedimentoRevocaSelezionato?.denominazioneBeneficiario == null ? "-" :
            procedimentoRevocaSelezionato?.denominazioneBeneficiario}}
          </strong>
        </div>
        <div class="mv-2">
          Bando:
          <strong>
            {{procedimentoRevocaSelezionato?.nomeBandoLinea == null ? "-" :
            procedimentoRevocaSelezionato?.nomeBandoLinea}}
          </strong>
        </div>
        <div>Codice Progetto:
          <strong>
            {{procedimentoRevocaSelezionato?.codiceVisualizzatoProgetto == null ? "-" :
            procedimentoRevocaSelezionato?.codiceVisualizzatoProgetto}}
          </strong>
        </div>
      </mat-card-content>
    </mat-card>


    <!-- INIZIO FORM -->
    <form [formGroup]="myForm">

      <!-- MAT CARD 2 -->
      <mat-card class="mat-elevation-z4 marginTop20">
        <mat-card-content class="mat-card-content">

          <div class="fullWidth">
            <div>Numero procedimento di revoca:
              <strong>
                {{procedimentoRevocaSelezionato?.numeroProcedimentoRevoca == null ? "-" :
                procedimentoRevocaSelezionato?.numeroProcedimentoRevoca}}
              </strong>
            </div>
          </div>

          <!--
          <div class="d-grid-2">
            <div class="fullWidth">


              <mat-form-field class="elem1 w-90" appearance="standard">
                <mat-label>Numero di protocollo</mat-label>
                <input matInput type="number" formControlName="numeroDiProtocollo">
                <mat-error *ngIf="myForm.get('numeroDiProtocollo')?.errors?.required">
                  È obbligatorio specificare il numero di protocollo
                </mat-error>
              </mat-form-field>
            </div>


            <div class="fullWidth">
              <mat-form-field class="elem1 w-90" appearance="standard">
                <mat-label>Data avvio proced. di revoca:</mat-label>
                <input matInput [matDatepicker]="picker1" placeholder="DD/MM/YYY" formControlName="dataAvvioProcRevoc" />
              <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
              <mat-datepicker #picker1></mat-datepicker>
              </mat-form-field>
            </div>

          </div>
          -->
          <div class="fullWidth mv-2">
            <div>Numero di protocollo:
              <strong>
                {{procedimentoRevocaSelezionato?.numeroProtocollo == null ? "-" :
                procedimentoRevocaSelezionato?.numeroProtocollo}}
              </strong>
            </div>
          </div>
          <div class="fullWidth mv-2">
            <div>Data avvio procedimento di revoca:
              <strong>
                {{procedimentoRevocaSelezionato?.dataAvvioProcedimento == null ? "-" :
                procedimentoRevocaSelezionato?.dataAvvioProcedimento|date:"dd/MM/yyyy"}}
              </strong>
            </div>
          </div>


          <div class="fullWidth mv-2">
            <div>Causa procedimento di revoca:
              <strong>
                {{procedimentoRevocaSelezionato?.descCausaleBlocco == null ? "-" :
                procedimentoRevocaSelezionato?.descCausaleBlocco}}
              </strong>
            </div>
          </div>

          <div class="fullWidth">
            <div>Autorità controllante:
              <strong>
                {{procedimentoRevocaSelezionato?.descAutoritaControllante == null ? "-" :
                procedimentoRevocaSelezionato?.descAutoritaControllante}}
              </strong>
            </div>
          </div>

        </mat-card-content>
      </mat-card>


      <!-- MAT CARD 3 -->
      <mat-card class="mat-elevation-z4 marginTop20">
        <mat-card-content class="mat-card-content">
          <div>Stato procedimento di revoca:
            <strong>
              {{procedimentoRevocaSelezionato?.descStatoRevoca == null ? "-" :
              procedimentoRevocaSelezionato?.descStatoRevoca}}
            </strong>
          </div>
          <div class="mv-2">Data stato di procedimento revoca:
            <strong>
              {{procedimentoRevocaSelezionato?.dataStatoRevoca == null ? "-" :
              procedimentoRevocaSelezionato?.dataStatoRevoca | date:'dd/MM/yyyy'}}
            </strong>
          </div>
          <div class="mv-2">Attività:
            <strong>
              {{procedimentoRevocaSelezionato?.descAttivitaRevoca == null ? "-" :
              procedimentoRevocaSelezionato?.descAttivitaRevoca}}
            </strong>
          </div>
          <div>Data attività:
            <strong>
              {{procedimentoRevocaSelezionato?.dataAttivitaRevoca == null ? "-" :
              procedimentoRevocaSelezionato?.dataAttivitaRevoca | date:'dd/MM/yyyy'}}
            </strong>
          </div>
        </mat-card-content>
      </mat-card>


      <!-- MAT CARD 4 -->
      <mat-card class="mat-elevation-z4 marginTop20">
        <mat-card-content class="mat-card-content fullWidth">
          <div class="d-grid-2">
            <!-- riga 1 -->
            <div class="fullWidth" style="margin: auto;">
              <strong>Gestione scadenze</strong>
            </div>
            <div class="fullWidth d-flex" style="margin: auto;" [hidden]="hiddenRichiestaProroga">
              <div *ngIf="numeroRichiesteProroga == 0">
                <p>
                  RICHIESTA PROROGA
                  <mat-icon class="blue-icon" matBadge="{{numeroRichiesteProroga}}" matBadgeColor="warn">
                    notifications_none
                  </mat-icon>
                </p>
              </div>

              <div *ngIf="numeroRichiesteProroga == 1">
                <a (click)="openRichiestaProroga()">
                  RICHIESTA PROROGA
                  <mat-icon class="blue-icon" matBadge="{{numeroRichiesteProroga}}" matBadgeColor="warn">
                    notifications_none
                  </mat-icon>
                </a>
              </div>


            </div>

            <!-- riga 2 -->
            <div class="fullWidth mv-2">
              <mat-form-field class="elem1 w-90" appearance="standard">
                <mat-label>Data notifica</mat-label>
                <input [disabled]="procedimentoRevocaSelezionato?.idStatoRevoca == '4' || procedimentoRevocaSelezionato?.idStatoRevoca == '9' || procedimentoRevocaSelezionato?.idStatoRevoca == '10'" matInput [matDatepicker]="picker2" placeholder="DD/MM/YYY" formControlName="dataNotifica" />
                <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
                <mat-datepicker #picker2></mat-datepicker>
              </mat-form-field>
            </div>
            <div class="fullWidth" style="margin:auto">
              Giorni scadenza:
              <strong>
                {{procedimentoRevocaSelezionato?.giorniScadenza == null ? "-" :
                procedimentoRevocaSelezionato?.giorniScadenza}}
              </strong>
            </div>

            <!-- riga 3 -->
            <div class="fullWidth">
              Data scadenza:
              <strong>
                {{procedimentoRevocaSelezionato?.dataScadenza == null ? "-" :
                procedimentoRevocaSelezionato?.dataScadenza | date:'dd/MM/yyyy'}}
              </strong>
            </div>
            <div class="fullWidth">
              Proroga:
              <strong>
                {{procedimentoRevocaSelezionato?.proroga == null ? "-" :
                (procedimentoRevocaSelezionato?.proroga ? "Sì" : "No")}}
              </strong>
            </div>

          </div>
        </mat-card-content>
      </mat-card>


      <!-- MAT CARD 5 -->
      <mat-card class="mat-elevation-z4 marginTop20">
        <mat-card-content>
          <!-- Table -->
          <table mat-table [dataSource]="dataSource" class="tab mv-2">

            <ng-container matColumnDef="modalita">
              <th mat-header-cell *matHeaderCellDef> Modalità di agevolazione </th>
              <td mat-cell *matCellDef="let element">
                {{element.modalitaDesc}}
              </td>
            </ng-container>


            <ng-container matColumnDef="importoAmmessoIniziale">
              <th mat-header-cell *matHeaderCellDef> Importo amesso iniziale </th>
              <td mat-cell *matCellDef="let element"> {{element?.importoAmmessoIniziale == null ?
                "-" : element?.importoAmmessoIniziale | number:
                '1.2-2' : 'it'}} </td>
            </ng-container>


            <ng-container matColumnDef="impConcesso">
              <th mat-header-cell *matHeaderCellDef> Importo concesso </th>
              <td mat-cell *matCellDef="let element"> {{element?.importoConcesso == null ?
                "-" : element?.importoConcesso | number:
                '1.2-2' : 'it'}} </td>
            </ng-container>


            <ng-container matColumnDef="impRevocato">
              <th mat-header-cell *matHeaderCellDef> Importo già revocato </th>
              <td mat-cell *matCellDef="let element"> {{element?.importoRevocato == null ?
                "-" : element?.importoRevocato | number:
                '1.2-2' : 'it'}} </td>
            </ng-container>

            <ng-container matColumnDef="impErogato">
              <th mat-header-cell *matHeaderCellDef> Importo erogato </th>
              <td mat-cell *matCellDef="let element"> {{element?.importoErogato == null ?
                "-" : element?.importoErogato | number:
                '1.2-2' : 'it'}} </td>
            </ng-container>

            <ng-container matColumnDef="impRecuperato">
              <th mat-header-cell *matHeaderCellDef> Importo recuperato </th>
              <td mat-cell *matCellDef="let element"> {{element?.importoRecuperato == null ?
                "-" : element?.importoRecuperato | number:
                '1.2-2' : 'it'}} </td>
            </ng-container>

            <ng-container matColumnDef="impRimborsato">
              <th mat-header-cell *matHeaderCellDef> Importo rimborsato </th>
              <td mat-cell *matCellDef="let element"> {{element?.importoRimborsato == null ?
                "-" : element?.importoRimborsato | number:
                '1.2-2' : 'it'}} </td>
            </ng-container>


            <ng-container matColumnDef="impConcessoAlRevocato">
              <th mat-header-cell *matHeaderCellDef> Importo concesso al netto del revocato </th>
              <td mat-cell *matCellDef="let element"> {{element?.importoConcessoNeRevocato == null ?
                "-" : element?.importoConcessoNeRevocato | number:
                '1.2-2' : 'it'}} </td>
            </ng-container>

            <ng-container matColumnDef="impErogatoAlRecuperato">
              <th mat-header-cell *matHeaderCellDef> Importo erogato al netto del recuperato e rimborsato </th>
              <td mat-cell *matCellDef="let element"> {{element?.importoErogatoNeRecuperatoRimborsato == null ?
                "-" : element?.importoErogatoNeRecuperatoRimborsato | number:
                '1.2-2' : 'it'}} </td>
            </ng-container>

            <ng-container matColumnDef="impDaRevocare">
              <th mat-header-cell *matHeaderCellDef> Importo da revocare </th>
              <td mat-cell *matCellDef="let element; let i = index">
                <div *ngIf="element.modalita == 'CONTRIBUTO'">
                  <input type="text" pattern="([0-9]+[\.])*[0-9]*([,][0-9]+)?" matInput
                    formControlName="importoDaRevocareContributo" placeholder="0,00" 
                    (blur)="setImporto('importoDaRevocareContributo', this.myForm.get('importoDaRevocareContributo').value, element?.importoConcessoNeRevocato)"/>
                </div>
                <div *ngIf="element.modalita == 'FINANZIAMENTO'">
                  <input type="text" pattern="([0-9]+[\.])*[0-9]*([,][0-9]+)?" matInput
                    formControlName="importoDaRevocareFinanziamento" placeholder="0,00"
                    (blur)="setImporto('importoDaRevocareFinanziamento', this.myForm.get('importoDaRevocareFinanziamento').value, element?.importoConcessoNeRevocato)"/>
                </div>
                <div *ngIf="element.modalita == 'GARANZIA'">
                  <input type="text" pattern="([0-9]+[\.])*[0-9]*([,][0-9]+)?" matInput
                    formControlName="importoDaRevocareGaranzia" placeholder="0,00"
                    (blur)="setImporto('importoDaRevocareGaranzia', this.myForm.get('importoDaRevocareGaranzia').value, element?.importoConcessoNeRevocato)"/>
                </div>
                <!-- <input type="number" matInput [(ngModel)]="listaElementiDatasource[i].importoDaRevocare" /> -->
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let element; columns: displayedColumns;"></tr>
          </table>
        </mat-card-content>
      </mat-card>


      <!-- MAT CARD 6 -->
      <mat-card class="mat-elevation-z4 marginTop20">
        <mat-card-content class="mat-card-content">
          <mat-label>Allegati:</mat-label>
          <div *ngIf="documentiRevoca?.length == 0" class="fullWidth mv-2">Nessun allegato presente</div>
          <div *ngIf="documentiRevoca?.length > 0" class="fullWidth mv-2">
            <div class="d-flex" *ngFor="let element of documentiRevoca">
              <div>
                <!--
                <mat-icon [ngClass]="{'visibility-hidden': !isAnteprimaVisible(row.documento, row.codTipoDoc)}"
                  class="cursor-pointer margin-right-5" (click)="anteprimaAllegato(row)">
                  remove_red_eye</mat-icon>
                -->
                <a class="blue-color bold-text" matTooltip="Download allegato"
                  (click)="downloadAllegato(element.idDocumento)">{{element.nomeFile}}</a>
              </div>
              <div [hidden]="
                ((procedimentoRevocaSelezionato.idStatoRevoca != 4) && (element.idTipoDocumento == 52 || element.idTipoDocumento == 46)) ||
                ((element.bozza) && (element.idTipoDocumento == 51 || element.idTipoDocumento == 45)) ||
                ((procedimentoRevocaSelezionato.idStatoRevoca == 5) && (element.idTipoDocumento == 50 || element.idTipoDocumento == 44))
              ">
                <p>: {{element?.originiDocumento}} il {{element?.dataDocumento == null ? "-" :
                  element?.dataDocumento | date:'dd/MM/yyyy'}}</p>
              </div>

            </div>
          </div>
        </mat-card-content>
      </mat-card>


      <!-- MAT CARD 7 -->
      <mat-card class="mat-elevation-z4 marginTop20">
        <mat-card-content class="mat-card-content">
          <mat-form-field appearance="standard" class="fullWidth">
            <mat-label class="mv-2">Note:</mat-label>
            <textarea matInput formControlName="note" type="text"></textarea>
          </mat-form-field>
        </mat-card-content>
      </mat-card>



      <!-- MAT CARD 8 -->
      <mat-card class="mat-elevation-z4 marginTop20">
        <mat-card-content class="mat-card-content">
          Istruttore che ha avviato l'istruttoria: <strong>{{user?.nome}} {{user?.cognome}}</strong>
        </mat-card-content>
      </mat-card>

    </form>

  </div>
  
  <div class="content">
    <mat-card class="mat-elevation-z4">
      <mat-card-content class="mat-card-content">
        <div class="display-flex-content-right">
          <div [hidden]="onlyRead" class="ml-5">
            <button mat-raised-button (click)="salva()" class="button-style-2">SALVA</button>
          </div>
          <div [hidden]="hiddenCreaBozza" class="ml-5">
            <button mat-raised-button (click)="creaBozzaProvvedimento()" class="button-style-3">CREA BOZZA PROVVEDIMENTO</button>
          </div>
          <div [hidden]="hiddenArchivia" class="ml-5">
            <button mat-raised-button (click)="archivia()" class="button-style-2">ARCHIVIA</button>
          </div>
          <div [hidden]="hiddenRichiediIntegrazione" class="ml-5">
            <button mat-raised-button (click)="richiediIntegrazione()" class="button-style-2" [disabled]="!abilitaRichiediIntegrazione">RICHIEDI INTEGRAZIONE</button>
          </div>
          <div [hidden]="!abilitaChiudiIntegrazione" class="ml-5">
            <button mat-raised-button (click)="chiudiRichiestaIntegrazione()" class="button-style-2">CHIUDI RICHIESTA INTEGRAZIONE</button>
          </div>
          <div [hidden]="hiddenAvviaProcedimento" class="ml-5">
            <button mat-raised-button (click)="avviaProcedimentoRevoca()" class="button-style-2">AVVIA PROCEDIMENTO DI REVOCA</button>
          </div>
          <div [hidden]="hiddenInviaIncarico" class="ml-5">
            <button mat-raised-button (click)="avviaIncaricoAdErogazionePerAvvioProcedimento()" class="button-style-2">INVIA INCARICO AD EROGAZIONE PER AVVIO PROCEDIMENTO</button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>