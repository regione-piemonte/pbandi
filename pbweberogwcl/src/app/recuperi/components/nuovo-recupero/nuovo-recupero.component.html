<mat-spinner-pbandi class="page" *ngIf="isLoading()"></mat-spinner-pbandi>
<div class="page" [ngClass]="{'displayNone': isLoading()}" id="scrollId">
    <div class="title">
        <div class="backContainer">
            <button (click)="goToRecuperi()" mat-button>
                <mat-icon class="blue-icon">keyboard_backspace</mat-icon>
                <span class="backText">Torna all'elenco dei recuperi</span>
            </button>
        </div>
        <div>
            <h2 class="margin-bottom-0">Nuovo recupero</h2>
        </div>
    </div>
    <div class="content">
        <mat-card class="mat-elevation-z2 messageSuccess" *ngIf="isMessageSuccessVisible">
            <mat-card-content class="messageSuccessContent">
                <p>{{messageSuccess}}</p>
            </mat-card-content>
        </mat-card>
        <mat-card class="mat-elevation-z2 messageWarning" *ngIf="isMessageWarningVisible">
            <mat-card-content class="messageWarningContent">
                <p>{{messageWarning}}</p>
            </mat-card-content>
        </mat-card>
        <mat-card class="mat-elevation-z2 messageError" *ngIf="isMessageErrorVisible">
            <mat-card-content class="messageErrorContent">
                <p>{{messageError}}</p>
            </mat-card-content>
        </mat-card>

        <mat-card class="mat-elevation-z2">
            <mat-card-content>
                <div class="cod-progetto">
                    <p>Beneficiario: <span class="bold-text">{{user?.beneficiarioSelezionato?.denominazione}}</span></p>
                </div>
                <div class="cod-progetto">
                    <p>Codice progetto: <span class="bold-text">{{codiceProgetto}}</span></p>
                    <button class="button-style-1 paddingLeft20" mat-button
                        (click)="goToDatiProgettoEAttivitaPregresse()">DATI
                        PROGETTO ATTIVIT&Agrave; PREGRESSE</button>
                </div>
            </mat-card-content>
        </mat-card>
    </div>

    <div class="content">
        <mat-card class="mat-elevation-z2">
            <mat-card-content>
                <form #nuovoForm="ngForm">
                    <div class="display-flex fullWidth">
                        <mat-form-field class="width-49-perc margin-right-10">
                            <mat-label> Selezionare una tipologia * </mat-label>
                            <mat-select [(ngModel)]="tipologiaSelected" name="tipologia" #tipo="ngModel"
                                [disabled]="confermaSalvataggio">
                                <mat-option *ngFor="let option of tipologie" [value]="option">
                                    {{option.descrizione}}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="tipo?.errors?.error === 'required'">
                                Campo obbligatorio
                            </mat-error>
                        </mat-form-field>
                        <mat-form-field class="width-data">
                            <mat-label> Data recupero *</mat-label>
                            <input matInput [matDatepicker]="picker1" name="dataRecupero" (click)="picker1.open()"
                                [(ngModel)]="dataRecupero" #dataR="ngModel" [disabled]="confermaSalvataggio">
                            <mat-datepicker-toggle matSuffix [for]="picker1" class="blue-color">
                            </mat-datepicker-toggle>
                            <mat-datepicker #picker1></mat-datepicker>
                            <mat-error *ngIf="dataR?.errors?.error === 'required'">
                                Campo obbligatorio
                            </mat-error>
                        </mat-form-field>
                    </div>

                    <div class="display-flex fullWidth">
                        <mat-form-field class="fullWidth">
                            <mat-label> Estremi determina </mat-label>
                            <input matInput name="estremiDetermina" [(ngModel)]="estremiDetermina"
                                [disabled]="confermaSalvataggio">
                        </mat-form-field>
                    </div>
                    <div class="display-flex fullWidth">
                        <mat-form-field class="fullWidth">
                            <mat-label> Note </mat-label>
                            <textarea matInput name="note" [(ngModel)]="note" rows="3" maxlength="255"
                                [disabled]="confermaSalvataggio"></textarea>
                        </mat-form-field>
                    </div>
                </form>
            </mat-card-content>
        </mat-card>
    </div>
    <div class="content">
        <mat-card class="mat-elevation-z2">
            <mat-card-content>
                <table mat-table [dataSource]="dataSource" class="fullWidth"
                    [ngClass]="{'displayNone':!dataSource || !dataSource.data || dataSource.data.length===0}">

                    <ng-container matColumnDef="modalitaDiAgevolazione">
                        <th mat-header-cell *matHeaderCellDef> Modalità di agevolazione </th>
                        <td mat-cell *matCellDef="let row"> {{row.label}} </td>
                    </ng-container>

                    <ng-container matColumnDef="ultimoImportoAgevolato">
                        <th mat-header-cell *matHeaderCellDef class="text-right"> Ultimo importo agevolato</th>
                        <td mat-cell *matCellDef="let row" class="text-right"> {{row.importoAgevolato | number: '1.2-2' :
                            'it'}}</td>
                    </ng-container>

                    <ng-container matColumnDef="importoGiaErogato">
                        <th mat-header-cell *matHeaderCellDef class="text-right"> Importo già erogato </th>
                        <td mat-cell *matCellDef="let row" class="text-right"> {{row.importoErogato | number: '1.2-2' :
                            'it'}} </td>
                    </ng-container>

                    <ng-container matColumnDef="importoGiaRevocato">
                        <th mat-header-cell *matHeaderCellDef class="text-right"> Importo totale delle revoche </th>
                        <td mat-cell *matCellDef="let row" class="text-right"> {{row.importoTotaleRevoche | number:
                            '1.2-2' : 'it'}} </td>
                    </ng-container>

                    <ng-container matColumnDef="dataRevoca">
                        <th mat-header-cell *matHeaderCellDef> Data della revoca </th>
                        <td mat-cell *matCellDef="let row"> {{row.dtRevoca }} </td>
                    </ng-container>

                    <ng-container matColumnDef="estremiDetermina">
                        <th mat-header-cell *matHeaderCellDef> Estremi della determina </th>
                        <td mat-cell *matCellDef="let row"> {{row.estremiRevoca }} </td>
                    </ng-container>

                    <ng-container matColumnDef="importoGiaRecuperato">
                        <th mat-header-cell *matHeaderCellDef class="text-right"> Importo già recuperato </th>
                        <td mat-cell *matCellDef="let row" class="text-right"> {{row.importoTotaleRecuperato | number:
                            '1.2-2' : 'it'}} </td>
                    </ng-container>

                    <ng-container matColumnDef="importoNuovoRecupero">
                        <th mat-header-cell *matHeaderCellDef class="text-right"> Importo nuovo recupero
                        </th>
                        <td mat-cell *matCellDef="let row">
                            <mat-form-field *ngIf="row.isRigaModalita" class="text-right">
                                <input matInput type="text" name="importoNuovoRecupero{{row.idModalitaAgevolazione}}"
                                    [(ngModel)]="row.importoNuovoRecuperoFormatted"
                                    pattern="([-]?[0-9]+[\.])*[0-9]*([,][0-9]+)?" (blur)="setImportoNuovoRecupero(row)"
                                    #imp="ngModel" [disabled]="confermaSalvataggio" />
                                <mat-error *ngIf="imp?.errors?.pattern">
                                    Valore non valido
                                </mat-error>
                            </mat-form-field>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                        [ngClass]="{'bold-text light-blue-background-color':row.isRigaModalita || row.isRigaTotale}">
                    </tr>
                </table>
                <div class="spaceBetween marginTop10" *ngIf="!confermaSalvataggio">
                    <button mat-raised-button class="button-style-2" (click)="recuperoTutto()">RECUPERO TOTALE
                    </button>
                    <button mat-raised-button class="button-style-2" (click)="checkRecuperi()">SALVA
                    </button>
                </div>

                <div class="spaceBetween marginTop10" *ngIf="confermaSalvataggio">
                    <button mat-raised-button class="button-style-2" (click)="annulla()"> ANNULLA
                    </button>
                    <button mat-raised-button class="button-style-2" (click)="conferma()">CONFERMA
                    </button>
                </div>

            </mat-card-content>
        </mat-card>
    </div>
</div>