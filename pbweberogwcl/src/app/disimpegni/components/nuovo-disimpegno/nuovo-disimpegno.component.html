<mat-spinner-pbandi class="page" *ngIf="isLoading()"></mat-spinner-pbandi>
<div class="page mx-24" [ngClass]="{'displayNone': isLoading()}" id="scrollId">
  <div class="title">
    <div class="backContainer">
      <button mat-button (click)="goToDisimpegni()">
        <mat-icon class="blue-icon">keyboard_backspace</mat-icon>
        <span class="backText">Torna ai disimpegni</span>
      </button>
    </div>
    <div>
      <h2>{{ title }}</h2>
    </div>
  </div>

  <div class="content">
    <mat-card class="mat-elevation-z2 marginBottom18 messageSuccess" *ngIf="isMessageSuccessVisible">
      <mat-card-content class="messageSuccessContent">
        <p [innerHTML]="messageSuccess | safeHTML"></p>
      </mat-card-content>
    </mat-card>
    <mat-card class="mat-elevation-z2 marginBottom18 messageWarning" *ngIf="isMessageWarningVisible">
      <mat-card-content class="messageWarningContent">
        <p [innerHTML]="messageWarning | safeHTML"></p>
      </mat-card-content>
    </mat-card>
    <mat-card class="mat-elevation-z2 marginBottom18 messageError" *ngIf="isMessageErrorVisible">
      <mat-card-content class="messageErrorContent">
        <p [innerHTML]="messageError | safeHTML"></p>
      </mat-card-content>
    </mat-card>
    <header-labels-buttons [class]="''" [labels]="headerLabels" [buttons]="headerButtons"
      (onBtnClick)="onHeaderButtonsClick($event)"></header-labels-buttons>
    <mat-card class="mat-elevation-z2 marginBottom18" [ngClass]="{'displayNone': action == 'inserisci' }">
      <mat-card-content class="overflow-auto">
        <h2>Riepilogo per modalità di agevolazione</h2>
        <div class="row no-gutters mt-12">
          <div class="col-auto w-25">
            <p class="margin0 pl-10 pr-10 text-right">Modalità di agevolazione</p>
          </div>
          <div class="col-auto w-75">{{dettaglioRevoca?.modalitaAgevolazione}}</div>
        </div>
        <div class="row no-gutters">
          <div class="col-auto w-25">
            <p class="margin0 pl-10 pr-10 text-right">Importo agevolato</p>
          </div>
          <div class="col-auto w-75">{{dettaglioRevoca?.importoAgevolato | number: '1.2-2': 'it'}}</div>
        </div>
        <div class="row no-gutters">
          <div class="col-auto w-25">
            <p class="margin0 pl-10 pr-10 text-right">Importo erogato</p>
          </div>
          <div class="col-auto w-75">{{dettaglioRevoca?.importoErogato | number: '1.2-2': 'it'}}</div>
        </div>
        <div class="row no-gutters">
          <div class="col-auto w-25">
            <p class="margin0 pl-10 pr-10 text-right">Importo disimpegnato</p>
          </div>
          <div class="col-auto w-75">{{dettaglioRevoca?.importoRevocato | number: '1.2-2': 'it'}}</div>
        </div>
        <div class="row no-gutters">
          <div class="col-auto w-25">
            <p class="margin0 pl-10 pr-10 text-right">Importo recuperato</p>
          </div>
          <div class="col-auto w-75">{{dettaglioRevoca?.importoRecuperato | number: '1.2-2': 'it'}}</div>
        </div>
      </mat-card-content>
    </mat-card>
    <mat-card class="mat-elevation-z2">
      <mat-card-content>
        <div class="header">
          <h2>Dati del disimpegno selezionato</h2>
        </div>
        <form #ricercaForm2="ngForm" (submit)="salva()">
          <mat-form-field class="row no-gutters display-flex w-50">
            <mat-label>Selezionare una Causale Disimpegno *</mat-label>
            <mat-select [(ngModel)]="fieldCodiceCausaleDisimpegnoSelected" name="causaleDisimpegno" class="w-100"
              matTooltip="{{ (fieldCodiceCausaleDisimpegnoSelected)?fieldCodiceCausaleDisimpegnoSelected.descrizione:'' }}"
              [disabled]="action == 'dettaglio' || (action === 'modifica' && isRevoca)"
              [compareWith]="compareWithCodiceDescrizione" (selectionChange)="onSelectCodiceCausaleDisimpegno()">
              <mat-option *ngFor="let causaleDisimpegno of causaliDisimpegno"
                [value]="extractCodiceDescrizione(causaleDisimpegno)">
                {{ causaleDisimpegno.descrizione }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field class="row no-gutters display-flex w-50">
            <mat-label>Selezionare un motivo (1)
            </mat-label>
            <mat-select [(ngModel)]="fieldMotivoRevocaSelected" name="fieldMotivoRevocaSelected" class="w-100"
              matTooltip="{{ (fieldMotivoRevocaSelected)?fieldMotivoRevocaSelected.descrizione:'' }}"
              [disabled]="action == 'dettaglio' || isDisabledRev" [compareWith]="compareWithCodiceDescrizione">
              <mat-option *ngFor="let motivazione of motivazioni" [value]="motivazione">
                <span>{{ motivazione.descrizione }}</span>
              </mat-option>
            </mat-select>
          </mat-form-field>
          <div class="row no-gutters">
            <div class="col-auto">
              <p class="margin0 margin-top-10 pr-10 text-right">Ordine di recupero (1)
              </p>
            </div>
            <div class="col-auto w-75 margin-top-10">
              <mat-radio-group class="w-100 justify-content-center" aria-label="Select an option"
                [(ngModel)]="flagOrdineRecupero" name="flagOrdineRecupero"
                [disabled]="action == 'dettaglio' || isDisabledRev">
                <mat-radio-button [value]="'S'" class="mr-10">Con ordine di recupero</mat-radio-button>
                <mat-radio-button [value]="'N'">Senza ordine di recupero</mat-radio-button>
              </mat-radio-group>
            </div>
          </div>
          <div class="row no-gutters">
            <mat-form-field class="col-auto display-flex w-50 marginRight20">
              <mat-label>Selezionare una modalità recupero (1)
              </mat-label>
              <mat-select [(ngModel)]="fieldModalitaRecuperoSelected" name="modalitaErogazione" class="w-100"
                matTooltip="{{ (fieldModalitaRecuperoSelected)?fieldModalitaRecuperoSelected.descrizione:'' }}"
                [disabled]="action == 'dettaglio' || isDisabledRev" [compareWith]="compareWithCodiceDescrizione">
                <mat-option *ngFor="let smodalitaRecupero of modalitaRecupero" [value]="smodalitaRecupero">
                  <span>{{ smodalitaRecupero.descrizione }}</span>
                </mat-option>
              </mat-select>
            </mat-form-field>
            <div class="col-auto ">
              <mat-form-field class="widthData widthData246">
                <mat-label>Data *</mat-label>
                <input matInput [matDatepicker]="pickerDataDal" name="dataDal" (click)="pickerDataDal.open()"
                  [(ngModel)]="dataRevoca" [disabled]="action == 'dettaglio'">
                <mat-datepicker-toggle matSuffix [for]="pickerDataDal" class="blueColor">
                </mat-datepicker-toggle>
                <mat-datepicker #pickerDataDal></mat-datepicker>
              </mat-form-field>
            </div>
          </div>
          <div class="row no-gutters">
            <div class="col-auto w-50">
              <mat-form-field class="row no-gutters w-100">
                <input class="w-100" type="text" matInput placeholder="Estremi determina"
                  name="fieldEstremiDeterminaRevoca" [(ngModel)]="fieldEstremiDeterminaRevoca" autocomplete="off"
                  [disabled]="action == 'dettaglio'">
              </mat-form-field>
            </div>
          </div>
          <div *ngIf="action == 'modifica'" class="row no-gutters">
            <div class="col-auto w-50">
              <mat-form-field class="row no-gutters w-100">
                <input class="w-100" type="text" [(inputNumber)]="inputNumberType"
                  pattern="([0-9]+[\.])*[0-9]*([,][0-9]+)?" matInput placeholder="Importo *" name="fieldImportoRevoca"
                  [(ngModel)]="fieldImportoRevoca" autocomplete="off"
                  [disabled]="action == 'dettaglio' || isAssociataIrr">
              </mat-form-field>
            </div>
          </div>
          <div class="row no-gutters">
            <mat-form-field class="w-100">
              <mat-label>Note</mat-label>
              <textarea matInput [(ngModel)]="fieldNoteRevoca" name="fieldNoteRevoca"
                [disabled]="action == 'dettaglio'"></textarea>
            </mat-form-field>
          </div>
          <div *ngIf="action == 'inserisci'" class="row no-gutters">
            <div class="col-auto">
              <p class="margin0 pr-10 "><span class="bold-text">Importo totale validato: </span>{{
                importoValidatoTotale | number: '1.2-2' : 'it' }}</p>
            </div>
          </div>
          <div *ngIf="action === 'inserisci' || action === 'modifica'" class="row no-gutters">
            (1) Campi obbligatori solo nel caso di revoche.
          </div>
          <div class="row no-gutters mt-12" *ngIf="action == 'inserisci'">
            <div class="col">
              <mat-card class="mat-elevation-z2 marginBottom18">
                <mat-card-content class="overflow-auto">
                  <table mat-table [dataSource]="dataSourceModalitaAgevolazioneErogazione" class="fullWidth"
                    [ngClass]="{'displayNone': !dataSourceModalitaAgevolazioneErogazione || !dataSourceModalitaAgevolazioneErogazione.data || dataSourceModalitaAgevolazioneErogazione.data.length===0}">

                    <ng-container matColumnDef="descBreveModalitaAgevolaz">
                      <th mat-header-cell *matHeaderCellDef> Modalità di agevolazione / Causale </th>
                      <td mat-cell *matCellDef="let row"> {{row.label}}
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="quotaImportoAgevolato">
                      <th mat-header-cell *matHeaderCellDef class="text-right">Importo agevolato</th>
                      <td mat-cell *matCellDef="let row" class="text-right">
                        {{row.importoAgevolato | number: '1.2-2' : 'it'}} </td>
                    </ng-container>

                    <ng-container matColumnDef="importoErogazioni">
                      <th mat-header-cell *matHeaderCellDef class="text-right">Importo erogato</th>
                      <td mat-cell *matCellDef="let row" class="text-right">
                        {{row.importoErogato | number: '1.2-2' : 'it'}} </td>
                    </ng-container>

                    <ng-container matColumnDef="totaleImportoRecuperato">
                      <th mat-header-cell *matHeaderCellDef class="text-right">Importo recuperato</th>
                      <td mat-cell *matCellDef="let row" class="text-right">
                        {{row.importoRecuperato | number: '1.2-2' : 'it'}} </td>
                    </ng-container>

                    <ng-container matColumnDef="data">
                      <th mat-header-cell *matHeaderCellDef> Data </th>
                      <td mat-cell *matCellDef="let row">{{row.data}}</td>
                    </ng-container>

                    <ng-container matColumnDef="importoNuovo">
                      <th mat-header-cell *matHeaderCellDef> Importo nuovo disimpegno </th>
                      <td mat-cell *matCellDef="let row;">
                        <span *ngIf="row.isRigaModalita">
                          <mat-form-field class="row no-gutters w-100">
                            <input type="text" matInput name="nuovo{{row.idModalitaAgevolazione}}"
                              [(ngModel)]="row.importoRevocaNewFormatted" pattern="([0-9]+[\.])*[0-9]*([,][0-9]+)?"
                              (blur)="setImportoNuovo(row)" #impNuovo="ngModel">
                            <mat-error *ngIf="impNuovo?.errors?.pattern">
                              Valore non valido
                            </mat-error>
                          </mat-form-field>
                        </span>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumnsModalitaAgevolazioneErogazione"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumnsModalitaAgevolazioneErogazione;"
                      [ngClass]="{'bold-text': row.isRigaTotale || row.isRigaModalita, 'light-blue-background-color': row.isRigaTotale || row.isRigaModalita}">
                    </tr>
                  </table>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
          <div class="row no-gutters mt-12" *ngIf="!(action == 'dettaglio')">
            <div matTooltip="Inserire tutti i campi obbligatori" [matTooltipDisabled]="!isFormDisabled()">
              <button class="button-style-2 margin0" mat-raised-button type="submit" [disabled]="isFormDisabled()">
                SALVA
              </button>
            </div>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

</div>