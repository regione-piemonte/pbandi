<mat-spinner-pbandi class="page" *ngIf="isLoading()"></mat-spinner-pbandi>
<div class="page" [ngClass]="{'display-none': isLoading()}" id="scrollId">
    <div class="title">
        <div class="backContainer">
            <button (click)="tornaAAttivitaDaSvolgere()" mat-button>
                <mat-icon class="blue-color">keyboard_backspace</mat-icon>
                <span class="backText">Torna alle attività da svolgere</span>
            </button>
        </div>
        <h2>Gestione integrazioni</h2>
    </div>
    <div class="content">
        <mat-card class="mat-elevation-z2">
            <mat-card-content>
                <div class="display-flex justify-content-space-between">
                    <div>
                        <div class="cod-progetto">
                            <p>Beneficiario: <span class="bold-text">{{ beneficiario }}</span></p>
                        </div>
                        <div class="cod-progetto">
                            <p>Codice progetto: <span class="bold-text">{{ codiceProgetto }}</span></p>
                        </div>
                    </div>
                    <pbcommon-help *ngIf="user?.codiceRuolo" [apiURL]="apiURL" [user]="user"
                        [descBrevePagina]="descBrevePagina"></pbcommon-help>
                </div>
            </mat-card-content>
        </mat-card>
    </div>

    <div class="content">
        <mat-card class="mat-elevation-z2 messageSuccess" *ngIf="isMessageSuccessVisible">
            <mat-card-content class="messageSuccessContent">
                <p>{{messageSuccess}}</p>
            </mat-card-content>
        </mat-card>

        <mat-card class="mat-elevation-z2 messageError" *ngIf="isMessageErrorVisible">
            <mat-card-content class="messageErrorContent">
                <p [innerHTML]="messageError"></p>
            </mat-card-content>
        </mat-card>
    </div>

    <div class="content">
        <!--RENDICONTAZIONE-->
        <div>
            <mat-expansion-panel (opened)="panel1OpenState = true" (closed)="panel1OpenState = false"
                [expanded]="panel1OpenState" [disabled]="!isFP">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        Integrazione alla rendicontazione ({{nRendicontazioni}})
                    </mat-panel-title>
                </mat-expansion-panel-header>
                <p *ngIf="!intRendicon || !intRendicon.length"><b>Non è stata ancora inserita nessuna richiesta di
                        integrazione.</b></p>

                <div>
                    <table mat-table [dataSource]="intRendiconDataSource"
                        [ngClass]="{'displayNone': !intRendicon || !intRendicon.length }" style="width: 100%;" matSort>

                        <!-- Numero dichiarazione di spesa -->
                        <ng-container matColumnDef="nDichiarazioneSpesa">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Numero dichiarazione di spesa </th>
                            <td mat-cell *matCellDef="let row"> {{row.nDichiarazioneSpesa === null ? "-" :
                                row.nDichiarazioneSpesa}} </td>
                        </ng-container>

                        <!-- Data richiesta -->
                        <ng-container matColumnDef="dataRichiesta">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data richiesta </th>
                            <td mat-cell *matCellDef="let row"> {{row.dataRichiesta === null ? "-" : row.dataRichiesta |
                                date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Data notifica -->
                        <ng-container matColumnDef="dataNotifica">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data notifica </th>
                            <td mat-cell *matCellDef="let row"> {{row.dataNotifica === null ? "-" : row.dataNotifica |
                                date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Data Scadenza -->
                        <ng-container matColumnDef="dataScadenza">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data Scadenza </th>
                            <td mat-cell *matCellDef="let row"> {{row.dataScadenza === null ? "-" : row.dataScadenza |
                                date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Data invio -->
                        <ng-container matColumnDef="dataInvio">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data invio </th>
                            <td mat-cell *matCellDef="let row"> {{row.dataInvio === null ? "-" : row.dataInvio |
                                date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Stato richiesta -->
                        <ng-container matColumnDef="longStatoRichiesta">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Stato richiesta </th>
                            <td mat-cell *matCellDef="let row"> {{row.longStatoRichiesta === null ? "-" :
                                row.longStatoRichiesta}} </td>
                        </ng-container>

                        <!-- Options -->
                        <ng-container matColumnDef="buttons">
                            <th mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let row" layout="row">
                                <div class="options">
                                    <!--BOTTONI NUOVI*ngIf="row.dataInvio === null && row.idStatoRichiesta === '1'"-->
                                    <button *ngIf="row.dataInvio === null && row.idStatoRichiesta == '1'"
                                        mat-icon-button (click)="integrazioneRendicontazione(row,'gestione')"
                                        matTooltip="Integra">
                                        <mat-icon>library_add</mat-icon>
                                    </button>
                                    <!--BOTTONI NUOVI*ngIf="row.dataInvio === null && row.idStatoRichiesta === '1'"-->
                                    <button *ngIf="row.idStatoRichiesta != '1'" mat-icon-button
                                        (click)="integrazioneRendicontazione(row,'storico')" matTooltip="Storico">
                                        <mat-icon>info</mat-icon>
                                    </button>
                                    <!--*ngIf="row.statoProroga === null && row.richiediProroga === true"-->
                                    <button
                                        *ngIf="row.idStatoRichiesta == 1 && row.statoProroga === null && row.richiediProroga === true"
                                        mat-icon-button (click)="richiediProroga(row,1,'rendicontazione')"
                                        matTooltip="Richiedi proroga">
                                        <mat-icon>edit_calendar</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoRichiesta == 1 && row.idStatoProroga == 3" mat-icon-button
                                        (click)="richiediProroga(row,2,'rendicontazione')"
                                        matTooltip="Richiesta proroga respinta">
                                        <mat-icon>event_busy</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoRichiesta != 1 && row.statoProroga !== null"
                                        mat-icon-button (click)="richiediProroga(row,2,'rendicontazione')"
                                        matTooltip="Storico proroghe">
                                        <mat-icon>event</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoRichiesta == 1 && row.idStatoProroga == 1" mat-icon-button
                                        (click)="richiediProroga(row,3,'rendicontazione')"
                                        matTooltip="Richiesta proroga inviata">
                                        <mat-icon>event_available</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoRichiesta == 1 && row.idStatoProroga == 2" mat-icon-button
                                        (click)="richiediProroga(row,4,'rendicontazione')"
                                        matTooltip="Invia nuova richiesta di proroga">
                                        <mat-icon>calendar_today</mat-icon>
                                    </button>

                                    <!-- <button *ngIf="row.idStatoRichiesta != '1'" mat-icon-button  (click)="dettaglio(row,'rendicontazione')" matTooltip="Visualizza dettaglio">
                                        <mat-icon >info</mat-icon>
                                    </button>  -->

                                    <button
                                        *ngIf="row.dataInvio === null && (row.allegatiInseriti === true || !this.isFP) && row.statoRichiesta !== descBreveStatoRichiestaChiusaUfficio"
                                        mat-icon-button (click)="invia(row,'rendicontazione')" matTooltip="Invia">
                                        <mat-icon>send</mat-icon>
                                    </button>
                                </div>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="rendiDisplayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: rendiDisplayedColumns;"></tr>
                    </table>
                </div>
            </mat-expansion-panel>
        </div>
        <br>
        <!--REVOCA-->
        <div [ngClass]="{'display-none': !isFP}">
            <mat-expansion-panel (opened)="panel2OpenState = true" (closed)="panel2OpenState = false">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        Integrazione alla revoca ({{nRevoche}})
                    </mat-panel-title>
                </mat-expansion-panel-header>
                <p *ngIf="!intRevoca || !intRevoca.length"><b>Non è stata ancora inserita nessuna richiesta di
                        integrazione.</b></p>

                <div>
                    <table mat-table [dataSource]="intRevDataSource"
                        [ngClass]="{'displayNone': !intRevoca || !intRevoca.length }" style="width: 100%;" matSort>

                        <!-- Numero protocollo -->
                        <ng-container matColumnDef="nRevoca">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Numero proc. di revoca </th>
                            <td mat-cell *matCellDef="let row"> {{row?.nRevoca}}</td>
                        </ng-container>

                        <!-- Data richiesta -->
                        <ng-container matColumnDef="dataRichiesta">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data richiesta </th>
                            <td mat-cell *matCellDef="let row"> {{row?.dataRichiesta | date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Data notifica -->
                        <ng-container matColumnDef="dataNotifica">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data notifica </th>
                            <td mat-cell *matCellDef="let row"> {{row?.dataNotifica | date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Data Scadenza -->
                        <ng-container matColumnDef="dataScadenza">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data Scadenza </th>
                            <td mat-cell *matCellDef="let row"> {{row?.dataScadenza | date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Data invio -->
                        <ng-container matColumnDef="dataInvio">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data invio </th>
                            <td mat-cell *matCellDef="let row"> {{row?.dataInvio | date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Stato richiesta -->
                        <ng-container matColumnDef="statoRichiesta">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Stato richiesta </th>
                            <td mat-cell *matCellDef="let row"> {{row?.statoRichiesta}} </td>
                        </ng-container>

                        <!-- Options -->
                        <ng-container matColumnDef="buttons">
                            <th mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let row" layout="row">
                                <div class="options">
                                    <!--BOTTONI NUOVI-->
                                    <button *ngIf="row.dataInvio === null && row.idStatoRichiesta === '1'"
                                        mat-icon-button (click)="integrazioneProcRevoca(row)" matTooltip="Integra">
                                        <mat-icon>library_add</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoProroga === null && row.idStatoRichiesta == '1'"
                                        mat-icon-button (click)="richiediProroga(row,1,'revoca')"
                                        matTooltip="Richiedi proroga">
                                        <mat-icon>edit_calendar</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoProroga == 3" mat-icon-button
                                        (click)="richiediProroga(row,2,'revoca')"
                                        matTooltip="Richiesta proroga respinta">
                                        <mat-icon>event_busy</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoProroga == 1" mat-icon-button
                                        (click)="richiediProroga(row,3,'revoca')"
                                        matTooltip="Richiesta proroga inviata">
                                        <mat-icon>event_available</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoProroga == 2 && row.idStatoRichiesta == '1'"
                                        mat-icon-button (click)="richiediProroga(row,4,'revoca')"
                                        matTooltip="Invia nuova richiesta di proroga">
                                        <mat-icon>calendar_today</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoProroga == 2 && row.idStatoRichiesta != '1'"
                                        mat-icon-button (click)="richiediProroga(row,5,'revoca')"
                                        matTooltip="Richiesta proroga approvata">
                                        <mat-icon>event_available</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoProroga == 4" mat-icon-button
                                        (click)="richiediProroga(row,6,'revoca')"
                                        matTooltip="Richiesta proroga chiusa d'ufficio">
                                        <mat-icon>event_busy</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoRichiesta != '1'" mat-icon-button
                                        (click)="dettaglio(row,'revoca')" matTooltip="Visualizza dettaglio">
                                        <mat-icon>info</mat-icon>
                                    </button>

                                    <button *ngIf="row.dataInvio === null && row.allegatiInseriti === true"
                                        mat-icon-button (click)="invia(row,'revoca')" matTooltip="Invia">
                                        <mat-icon>send</mat-icon>
                                    </button>
                                </div>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="revDisplayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: revDisplayedColumns;"></tr>
                    </table>
                </div>
            </mat-expansion-panel>
        </div>
        <br>
        <!--CONTROLLI-->
        <div [ngClass]="{'display-none': !isFP}">
            <mat-expansion-panel (opened)="panel3OpenState = true" (closed)="panel3OpenState = false">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        Integrazione ai controlli ({{nControlli}})
                    </mat-panel-title>
                </mat-expansion-panel-header>
                <p *ngIf="!intControlli || !intControlli.length"><b>Non è stata ancora inserita nessuna richiesta di
                        integrazione.</b></p>

                <div>
                    <table mat-table [dataSource]="intControlliDataSource"
                        [ngClass]="{'displayNone': !intControlli || !intControlli.length }" style="width: 100%;"
                        matSort>

                        <!-- Numero protocollo -->
                        <ng-container matColumnDef="nProtocollo">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Numero protocollo </th>
                            <td mat-cell *matCellDef="let row"> {{row.numProtocollo}} </td>
                        </ng-container>

                        <!-- Data richiesta -->
                        <ng-container matColumnDef="dataRichiesta">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data richiesta </th>
                            <td mat-cell *matCellDef="let row"> {{row.dtRich | date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Data notifica -->
                        <ng-container matColumnDef="dataNotifica">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data notifica </th>
                            <td mat-cell *matCellDef="let row"> {{row.dtNotifica | date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Data Scadenza -->
                        <ng-container matColumnDef="dataScadenza">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data Scadenza </th>
                            <td mat-cell *matCellDef="let row"> {{row.dtScadenza | date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Data invio -->
                        <ng-container matColumnDef="dataInvio">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Data invio </th>
                            <td mat-cell *matCellDef="let row"> {{row.dtInvio | date:'dd/MM/yyyy'}} </td>
                        </ng-container>

                        <!-- Stato richiesta -->
                        <ng-container matColumnDef="statoRichiesta">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Stato richiesta </th>
                            <td mat-cell *matCellDef="let row"> {{row.descStatoRich}} </td>
                        </ng-container>

                        <!-- Options -->
                        <ng-container matColumnDef="buttons">
                            <th mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let row" layout="row">
                                <div class="options">
                                    <button *ngIf="row.dtInvio === null && row.idStatoRich === 1" mat-icon-button
                                        (click)="integrazioneAiControlli(row)" matTooltip="Integra">
                                        <mat-icon>library_add</mat-icon>
                                    </button>
                                    <!--*ngIf="row?.descStatoContestazione === 'INVIATA'"-->
                                    <button *ngIf="row.statoProroga === null && row.idStatoRich == 1" mat-icon-button
                                        (click)="richiediProroga(row,1,'controlli')" matTooltip="Richiedi proroga">
                                        <mat-icon>edit_calendar</mat-icon>
                                    </button>

                                    <button *ngIf="row.statoProroga === 'RESPINTA' && row.idStatoRich == 1"
                                        mat-icon-button (click)="richiediProroga(row,2,'controlli')"
                                        matTooltip="Richiesta proroga respinta">
                                        <mat-icon>event_busy</mat-icon>
                                    </button>

                                    <button *ngIf="row.statoProroga === 'INVIATA' && row.idStatoRich == 1"
                                        mat-icon-button (click)="richiediProroga(row,3,'controlli')"
                                        matTooltip="Richiesta proroga inviata">
                                        <mat-icon>event_available</mat-icon>
                                    </button>

                                    <button *ngIf="row.statoProroga === 'APPROVATA' && row.idStatoRich == 1"
                                        mat-icon-button (click)="richiediProroga(row,4,'controlli')"
                                        matTooltip="Invia nuova richiesta di proroga">
                                        <mat-icon>calendar_today</mat-icon>
                                    </button>

                                    <button *ngIf="row.idStatoRich != 1" mat-icon-button
                                        (click)="dettaglio(row,'controlli')" matTooltip="Visualizza dettaglio">
                                        <mat-icon>info</mat-icon>
                                    </button>
                                    <!--*ngIf="row?.invia === true"-->
                                    <button *ngIf="row.dtInvio === null && row.allegatiInseriti === true"
                                        mat-icon-button (click)="invia(row,'controlli')" matTooltip="Invia">
                                        <mat-icon>send</mat-icon>
                                    </button>
                                </div>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="contDisplayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: contDisplayedColumns;"></tr>
                    </table>
                </div>
            </mat-expansion-panel>
        </div>
        <br>
    </div>
</div>