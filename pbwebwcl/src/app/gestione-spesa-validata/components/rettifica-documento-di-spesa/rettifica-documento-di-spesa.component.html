<mat-spinner-pbandi class="page" *ngIf="isLoading()"></mat-spinner-pbandi>
<div class="page" [ngClass]="{'displayNone': isLoading()}" id="scrollId">
    <div class="title">
        <div class="backContainer">
            <button (click)="tornaAGestioneSpesaValidata()" mat-button>
                <mat-icon class="blue-icon">keyboard_backspace</mat-icon>
                <span class="backText">Torna alla gestione spesa validata</span>
            </button>
        </div>
        <div class="reportingContainerUp">
            <div>
                <h2>Rettifica documento di spesa</h2>
            </div>
        </div>
    </div>
    <div class="content">
        <mat-card class="mat-elevation-z2 messageSuccess" *ngIf="isMessageSuccessVisible">
            <mat-card-content class="messageSuccessContent">
                <p [innerHTML]="messageSuccess"></p>
            </mat-card-content>
        </mat-card>
        <mat-card class="mat-elevation-z2 messageError" *ngIf="isMessageErrorVisible">
            <mat-card-content class="messageErrorContent">
                <p [innerHTML]="messageError"></p>
            </mat-card-content>
        </mat-card>
        <mat-card class="mat-elevation-z2">
            <mat-card-content>
                <div class="cod-progetto">
                    <p>Beneficiario: <span class="bold-text">{{beneficiario}}</span></p>
                </div>
                <div class="cod-progetto">
                    <p>Codice progetto: <span class="bold-text">{{codiceProgetto}}</span></p>
                    <button class="button-style-1 paddingLeft20" mat-button
                        (click)="datiProgettoEAttivitaPregresse()">DATI PROGETTO ATTIVIT&Agrave; PREGRESSE</button>
                    <button class="button-style-1 paddingLeft20" mat-button (click)="contoEconomico()">CONTO
                        ECONOMICO</button>
                </div>
                <div class="cod-progetto">
                    <p>{{docSpesa?.descrizioneTipologiaDocumento}}: <span class="bold-text">
                            <span *ngIf="docSpesa?.numeroDocumento">n. {{docSpesa?.numeroDocumento}} -</span>
                            {{docSpesa?.dataDocumento}}</span></p>

                </div>
                <div class="cod-progetto">
                    <p class="margin-top-6" *ngIf="docSpesa?.denominazioneFornitore">Fornitore: <span class="bold-text">
                            {{docSpesa?.denominazioneFornitore}}</span></p>
                </div>
            </mat-card-content>
        </mat-card>
    </div>

    <div class="content margin-bottom-0" *ngIf="isMessageWarningVisible">
        <mat-card class="mat-elevation-z2 messageWarning">
            <mat-card-content class="messageWarningContent">
                <p [innerHTML]="messageWarning"></p>
            </mat-card-content>
        </mat-card>
    </div>

    <div class="content" [ngClass]="{'margin-top-0': isMessageWarningVisible}">
        <div class="display-flex fullWidth margin-bottom-20">
            <app-allegati-dettaglio-doc style="width: 33%;" [docSpesa]="docSpesa" [isVisible]="isVisible" [isFP]="isFP"
                (messageError)="showMessageError($event)"
                (resetMessageError)="resetMessageError()"></app-allegati-dettaglio-doc>
            <div class="flex-direction-column margin-left-20" style="width: 65%;">
                <app-dati-gen-affid-dettaglio-doc [docSpesa]="docSpesa"
                    [isBR79]="isBR79"></app-dati-gen-affid-dettaglio-doc>

                <div class="card">
                    <mat-card class="mat-elevation-z2">
                        <mat-card-content>
                            <h3>Dichiarazione di spesa nÂ° {{idDichiarazioneDiSpesa}}</h3>
                            <p
                                *ngIf="!dataSourceVociSpesa || !dataSourceVociSpesa.data || dataSourceVociSpesa.data.length===0">
                                Non ci sono elementi da visualizzare</p>
                            <form #voceForm="ngForm">
                                <table mat-table [dataSource]="dataSourceVociSpesa" matSort matSortActive="desc"
                                    class="fullWidth"
                                    [ngClass]="{'displayNone': !dataSourceVociSpesa || !dataSourceVociSpesa.data || dataSourceVociSpesa.data.length===0}">

                                    <ng-container matColumnDef="desc">
                                        <th mat-header-cell *matHeaderCellDef> Voce di spesa </th>
                                        <td mat-cell *matCellDef="let row"> {{row.descrizioneVoceDiSpesa}}
                                        </td>
                                    </ng-container>

                                    <ng-container matColumnDef="associato">
                                        <th mat-header-cell *matHeaderCellDef class="text-right"> Importo associato</th>
                                        <td mat-cell *matCellDef="let row" class="text-right">
                                            {{row.importoAssociatoVoceDiSpesa | number: '1.2-2' : 'it'}}
                                        </td>
                                    </ng-container>

                                    <ng-container matColumnDef="validatoPrec">
                                        <th mat-header-cell *matHeaderCellDef class="text-right"> Importo validato</th>
                                        <td mat-cell *matCellDef="let row" class="text-right">
                                            {{row.importoValidatoPrecedenteVoceDiSpesa | number: '1.2-2' : 'it'}}
                                        </td>
                                    </ng-container>

                                    <ng-container matColumnDef="validato">
                                        <th mat-header-cell *matHeaderCellDef class="text-right width-15-perc"> Nuovo
                                            importo validato
                                        </th>
                                        <td mat-cell *matCellDef="let row" class="imp width-15-perc">
                                            <div class="flexEnd">
                                                <mat-form-field class="text-right width-90-perc">
                                                    <input type="text" matInput
                                                        [(ngModel)]="row.importoValidatoVoceDiSpesaFormatted"
                                                        name="importo{{row.idQuotaParte}}"
                                                        pattern="([0-9]+[\.])*[0-9]*([,][0-9]+)?"
                                                        (blur)="setImporto(row)" #imp="ngModel"
                                                        [disabled]="isRagioneriaDelegata || idStatoRichiesta == 1 || idStatoRichiesta == 4 || isSospeso" />
                                                    <mat-error *ngIf="imp?.errors?.error === 'maggiore'">
                                                        Il valore deve essere minore o uguale all'importo associato alla
                                                        voce di
                                                        spesa
                                                    </mat-error>
                                                    <mat-error *ngIf="imp?.errors?.pattern">
                                                        Valore non valido
                                                    </mat-error>
                                                </mat-form-field>
                                            </div>
                                        </td>
                                    </ng-container>

                                    <ng-container matColumnDef="rettifica">
                                        <th mat-header-cell *matHeaderCellDef class="text-right"> Totale rettifica</th>
                                        <td mat-cell *matCellDef="let row" class="text-right"
                                            [ngClass]="{'red-color': row.importoTotaleRettifica > 0}">
                                            {{row.importoTotaleRettifica | number: '1.2-2' : 'it'}}
                                        </td>
                                    </ng-container>

                                    <ng-container matColumnDef="rif">
                                        <th mat-header-cell *matHeaderCellDef class="width-20-perc"> Riferimento
                                        </th>
                                        <td mat-cell *matCellDef="let row" class="rif width-20-perc">
                                            <mat-form-field class="width-90-perc">
                                                <input type="text" matInput [(ngModel)]="row.note"
                                                    name="rif{{row.idQuotaParte}}" maxlength="255"
                                                    [disabled]="isRagioneriaDelegata || idStatoRichiesta == 1 || idStatoRichiesta == 4 || isSospeso" />
                                            </mat-form-field>
                                        </td>
                                    </ng-container>


                                    <ng-container matColumnDef="azioni">
                                        <th mat-header-cell *matHeaderCellDef class="azioni"></th>
                                        <td mat-cell *matCellDef="let row">
                                            <div class="display-flex">
                                                <button
                                                    *ngIf="row.rigaModificabile && !isRagioneriaDelegata && !(idStatoRichiesta == 1 || idStatoRichiesta == 4) && !isSospeso"
                                                    mat-icon-button matTooltip="Modifica voce di spesa"
                                                    (click)="openModificaVoceSpesa(row.idQuotaParte)">
                                                    <mat-icon>edit</mat-icon>
                                                </button>
                                                <button *ngIf="rettificato && row.linkRettifiche==='OK'" mat-icon-button
                                                    matTooltip="Dettaglio rettifiche"
                                                    (click)="openDettaglioRettifiche(row.progrPagQuotParteDocSp)">
                                                    <mat-icon>history</mat-icon>
                                                </button>
                                            </div>
                                        </td>
                                    </ng-container>

                                    <tr mat-header-row *matHeaderRowDef="displayedColumnsVociSpesa"></tr>
                                    <tr mat-row *matRowDef="let row; columns: displayedColumnsVociSpesa;"></tr>
                                </table>
                            </form>
                            <div class="flex marginTop20"
                                *ngIf="!((isVisible || ((!isFP || isBR79))) && isBR63 && !isRagioneriaDelegata)">
                                <span class="marginRight10 bold-text">Note di validazione</span>
                                {{docSpesa?.noteValidazione ?
                                docSpesa.noteValidazione : 'Nessuna'}}
                            </div>
                        </mat-card-content>
                    </mat-card>
                </div>

                <app-note-credito-dettaglio-doc [docSpesa]="docSpesa" (messageError)="showMessageError($event)"
                (resetMessageError)="resetMessageError()"></app-note-credito-dettaglio-doc>

                <div class="card" *ngIf="isBR63">
                    <mat-card class="mat-elevation-z2">
                        <mat-card-content>
                            <div class="display-flex align-items-center justify-content-space-between">
                                <h3>Rilievi della Ragioneria Delegata</h3>
                                <button *ngIf="isRagioneriaDelegata && !isNoteRilievo && !dtChiusuraRilievi"
                                    mat-raised-button class="button-style-2" (click)="aggiungiModificaRilievo()">
                                    AGGIUNGI RILIEVO
                                    CONTABILE</button>
                            </div>
                            <p *ngIf="!isNoteRilievo">Nessun rilievo da visualizzare.</p>
                            <div *ngIf="isNoteRilievo">
                                <div class="display-flex align-items-center">
                                    <p [ngClass]="{'margin-0': !dtChiusuraRilievi}"><span class="bold-text">Rilievo
                                            contabile:&nbsp;</span>{{noteRilievo}}
                                    </p>
                                    <button *ngIf="isRagioneriaDelegata && !dtChiusuraRilievi" mat-icon-button
                                        matTooltip="Modifica rilievo"
                                        (click)="aggiungiModificaRilievo()"><mat-icon>edit</mat-icon></button>
                                    <button *ngIf="isRagioneriaDelegata && !dtChiusuraRilievi" mat-icon-button
                                        matTooltip="Elimina rilievo" (click)="deleteRilievo()"
                                        class="red-color"><mat-icon>delete</mat-icon></button>
                                </div>
                                <p><span class="bold-text">Data
                                        rilievo:&nbsp;</span>{{rilievo.dtRilievoContabile ?
                                    (rilievo.dtRilievoContabile | date:'dd/MM/yyyy') : 'n.d.'}}
                                </p>
                            </div>
                        </mat-card-content>
                    </mat-card>
                </div>

                <div class="card" *ngIf="(isVisible || ((!isFP || isBR79))) && isBR63 && !isRagioneriaDelegata">
                    <mat-card class="mat-elevation-z2">
                        <mat-card-content>
                            <h3 class="margin-bottom-0">Note per il beneficiario</h3>
                            <mat-form-field *ngIf="docSpesa" class="fullWidth">
                                <textarea type="text" matInput [(ngModel)]="docSpesa.noteValidazione"
                                    name="noteValidazione" maxlength="4000"
                                    [disabled]="idStatoRichiesta == 1 || idStatoRichiesta == 4"></textarea>
                                <mat-hint>{{4000-docSpesa.noteValidazione?.length}} caratteri disponibili</mat-hint>
                            </mat-form-field>
                        </mat-card-content>
                    </mat-card>
                </div>
            </div>
        </div>
    </div>

    <div class="content" *ngIf="bottoneSalvaVisibile && !isRagioneriaDelegata">
        <div class="flexEnd">
            <!-- come per il pulsante di richiedi integrazione piu br63: -->
            <button mat-stroked-button class="button-style-3 margin-left-20"
                *ngIf="!isSospeso && isBR63 && (isVisible || ((!isFP || isBR79)))"
                [disabled]="idStatoRichiesta == 1 || idStatoRichiesta == 4" (click)="sospendi()">SOSPENDI</button>
            <button mat-stroked-button class="button-style-3 margin-left-20"
                *ngIf="isSospeso && isBR63 && (isVisible || ((!isFP || isBR79)))"
                [disabled]="idStatoRichiesta == 1 || idStatoRichiesta == 4" (click)="annullaSospendi()">ANNULLA
                SOSPENDI</button>
            <button mat-raised-button class="button-style-2 marginLeft20" (click)="salva()"
                [disabled]="isSalvaDisabled()">SALVA</button>
        </div>
    </div>
</div>