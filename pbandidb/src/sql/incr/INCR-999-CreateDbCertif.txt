/*******************************************************************************
* Copyright Regione Piemonte - 2024
* SPDX-License-Identifier: EUPL-1.2
******************************************************************************/

-- Controlli certificazione
CREATE OR REPLACE TYPE OBJCTRLCERTIF AS OBJECT
(
CODICE_VISUALIZZATO VARCHAR2(100),
ID_PROGETTO NUMBER(8),
ID_PROPOSTA_CERTIFICAZ NUMBER(8),
ID_UTENTE_INS NUMBER(8),
NOME_BANDO_LINEA VARCHAR2(255),
IMPORTO_EROGAZIONI NUMBER(13,2),
ID_TIPO_OPERAZIONE NUMBER(3),
ID_DOMANDA NUMBER(8),
PROGR_BANDO_LINEA_INTERVENTO NUMBER(8),
IMPORTO_PAGAMENTI_VALIDATI NUMBER(13,2),
ID_LINEA_DI_INTERVENTO NUMBER(3),
FLAG_SIF VARCHAR2(1),
PROGR_BANDO_LINEA_INTERV_SIF NUMBER(8),
ID_PROGETTO_FINANZ NUMBER(8)
)
/

CREATE OR REPLACE TYPE LISTCTRLCERTIF AS TABLE OF OBJCTRLCERTIF
/

-- Crea Certificazione
CREATE OR REPLACE TYPE OBJCREACERTIF AS OBJECT
(
ID_DETT_PROPOSTA_CERTIF NUMBER(8), 
ID_PROPOSTA_CERTIFICAZ NUMBER(8), 
COSTO_AMMESSO NUMBER(13,2),
IMPORTO_PAGAMENTI_VALIDATI  NUMBER(13,2),
IMPORTO_PAG_VALIDATI_ORIG  NUMBER(13,2), 
IMPORTO_EROGAZIONI NUMBER(13,2), 
IMPORTO_FIDEIUSSIONI NUMBER(13,2),
SPESA_CERTIFICABILE_LORDA NUMBER(13,2), 
ID_PROGETTO NUMBER(8), 
ID_UTENTE_INS NUMBER(8), 
ID_UTENTE_AGG NUMBER(8),
IMPORTO_ECCENDENZE_VALIDAZIONE NUMBER(13,2),
TITOLO_PROGETTO VARCHAR2(2000),
NOME_BANDO_LINEA VARCHAR2(255),
FLAG_CHECK_LIST_IN_LOCO VARCHAR(1),
FLAG_CHECK_LIST_CERTIFICAZIONE VARCHAR(1),
ID_STATO_PROGETTO NUMBER(3),
ID_TIPO_OPERAZIONE  NUMBER(3),
DT_ULTIMA_CHECKLIST_IN_LOCO DATE,
IMPORTO_RENDICONTATO NUMBER(17,2),
FLAG_ATTIVO VARCHAR(1),
ID_LINEA_DI_INTERVENTO NUMBER(3)
)
/

CREATE OR REPLACE TYPE LISTCREACERTIF AS TABLE OF OBJCREACERTIF
/



CREATE TABLE PBANDI_T_PREVIEW_DETT_PROP_REV
(
  id_preview_dett_prop_cer     NUMBER not null,
  nome_bando_linea             VARCHAR2(255) not null,
  codice_progetto              VARCHAR2(100) not null,
  denominazione_beneficiario   VARCHAR2(255) not null,
  importo_certificazione_netto NUMBER(17,2),
  importo_revoche              NUMBER(17,2),
  flag_attivo                  CHAR(1) not null,
  id_proposta_certificaz       NUMBER(8) not null,
  id_progetto                  NUMBER(8) not null,
  importo_pagamenti            NUMBER(17,2),
  id_utente_ins                NUMBER(8) not null,
  id_utente_agg                NUMBER(8),
  progr_bando_linea_intervento NUMBER(8) not null,
  id_soggetto_beneficiario     NUMBER(8) not null,
  id_linea_di_intervento       NUMBER(3)
);

create unique index pbandi.marco_idx 
on pbandi.PBANDI_T_PREVIEW_DETT_PROP_REV 
( ID_PROPOSTA_CERTIFICAZ, ID_PROGETTO )
tablespace pbandi_idx;


--
--PBANDI_T_DETT_PROPOSTA_CERTIF
CREATE TABLE PBANDI_T_DETT_PROPOSTA_REV
(
  ID_DETT_PROPOSTA_CERTIF         NUMBER(8)     NOT NULL,
  ID_PROPOSTA_CERTIFICAZ          NUMBER(8)     NOT NULL,
  COSTO_AMMESSO                   NUMBER(13,2),
  IMPORTO_PAGAMENTI_VALIDATI      NUMBER(13,2),
  IMPORTO_EROGAZIONI              NUMBER(13,2),
  IMPORTO_FIDEIUSSIONI            NUMBER(13,2),
  SPESA_CERTIFICABILE_LORDA       NUMBER(13,2),
  ID_PROGETTO                     NUMBER(8)     NOT NULL,
  ID_UTENTE_INS                   NUMBER(8)     NOT NULL,
  ID_UTENTE_AGG                   NUMBER(8),
  IMPORTO_ECCENDENZE_VALIDAZIONE  NUMBER(13,2),
  IMPORTO_REVOCHE                 NUMBER(17,2),
  DT_ULTIMA_REVOCA                DATE,
  IMPORTO_DA_RECUPERARE           NUMBER(17,2),
  IMPORTO_PRERECUPERI             NUMBER(17,2),
  DT_ULTIMO_PRERECUPERO           DATE,
  IMPORTO_RECUPERI                NUMBER(17,2),
  DT_ULTIMO_RECUPERO              DATE,
  IMPORTO_SOPPRESSIONI            NUMBER(17,2),
  DT_ULTIMA_SOPPRESSIONE          DATE,
  IMPORTO_NON_RILEVANTE_CERTIF    NUMBER(17,2),
  IMPORTO_CERTIFICAZIONE_NETTO    NUMBER(17,2),
  IDENTIFICATIVI_IRREGOLARITA     VARCHAR2(300),
  EROGAZIONI_IN_MENO_PER_ERRORE   NUMBER(17,2),
  FIDEIUSSIONI_IN_MENO_PER_ERROR  NUMBER(17,2),
  SOPPRESSIONI_IN_MENO_PER_ERROR  NUMBER(17,2),
  PRERECUPERI_IN_MENO_PER_ERROR   NUMBER(17,2),
  RECUPERI_IN_MENO_PER_ERRORE     NUMBER(17,2),
  REVOCHE_IN_MENO_PER_ERROR       NUMBER(17,2),
  FLAG_COMP                       CHAR(1)  DEFAULT 'N'                   NOT NULL,
  TITOLO_PROGETTO                 VARCHAR2(2000),
  NOME_BANDO_LINEA                VARCHAR2(255),
  CONTRIBUTO_PUBBLICO_CONCESSO    NUMBER(17,2),
  FLAG_CHECK_LIST_IN_LOCO         CHAR(1)  DEFAULT 'N'                   NOT NULL,
  FLAG_CHECK_LIST_CERTIFICAZIONE  CHAR(1)  DEFAULT 'N'                   NOT NULL,
  ID_STATO_PROGETTO               NUMBER(3),
  ID_TIPO_OPERAZIONE              NUMBER(3),
  ID_INDIRIZZO_SEDE_LEGALE        NUMBER(9),
  ID_PERSONA_FISICA               NUMBER(8),
  ID_ENTE_GIURIDICO               NUMBER(8),
  ID_DIMENSIONE_IMPRESA           NUMBER(3),
  DT_ULTIMA_CHECKLIST_IN_LOCO     DATE,
  IMPORTO_RENDICONTATO            NUMBER(17,2),
  IMPORTO_INTERESSI_RECUPERATI    NUMBER(17,2),
  IMP_INTERESSI_RECUPERATI_NETTI  NUMBER(17,2),
  IMP_CERTIFICABILE_NETTO_SOPPR   NUMBER(17,2),
  IMP_REVOCHE_NETTO_SOPPRESSIONI  NUMBER(17,2),
  IMP_CERTIFICABILE_NETTO_REVOC   NUMBER(17,2),
  IMPORTO_REVOCHE_INTERMEDIO      NUMBER(17,2),
  IMP_CERTIFICAZIONE_NETTO_PREC   NUMBER(17,2),
  AVANZAMENTO                     NUMBER(17,2),
  IMPORTO_SOPPRESSIONI_NETTO      NUMBER(17,2),
  IMPORTO_RECUPERI_PRERECUPERI    NUMBER(17,2),
  FLAG_ATTIVO                     CHAR(1)  DEFAULT 'S'                   NOT NULL,
  FLAG_CORREZIONE_CN              CHAR(1)  DEFAULT 'N'                   NOT NULL,
  ID_LINEA_DI_INTERVENTO          NUMBER(3),
  IMP_CERTIFICAZIONE_NETTO_BCK    NUMBER(17,2),
  IMP_CERTIF_NETTO_PREMODIFICA    NUMBER(17,2),
  CODICE_PROGETTO                 VARCHAR2(100),
  DENOMINAZIONE_BENEFICIARIO      VARCHAR2(255),
  NOTA                            VARCHAR2(4000),
  QUOTA_REVOCA_PER_IRR            NUMBER(17,2),
  NUM_PERC_SPESA_PUBBLICA         NUMBER(3),
  IMPORTO_CERT_NET_ANNO_PREC      NUMBER(13,2),
  IMPORTO_CERT_NET_ANNO_IN_CORSO  NUMBER(13,2),
  IMPORTO_CERT_NET_ANNI_PREC      NUMBER(13,2),
  IMPORTO_PAG_VALIDATI_ORIG       NUMBER(13,2),
  VALORE_N                        NUMBER(17,2),
  VALORE_N_1                      NUMBER(17,2),
  SOMMA_VALORI_N                  NUMBER(17,2)
)
TABLESPACE PBANDI_TBL;

COMMENT ON COLUMN PBANDI_T_DETT_PROPOSTA_REV.IMP_CERTIFICAZIONE_NETTO_BCK IS 'Backup del valore della colonna IMPORTO_CERTIFICATO_NETTO quando questo è negativo';

COMMENT ON COLUMN PBANDI_T_DETT_PROPOSTA_REV.IMP_CERTIF_NETTO_PREMODIFICA IS 'Importo certificazione netto calcolato dalla procedura e non modificabile da on-line';

COMMENT ON COLUMN PBANDI_T_DETT_PROPOSTA_REV.SOMMA_VALORI_N IS 'DERIVA DALLA SEGUENTE FORMULA --> somma_valori_n = GREATEST (NVL(valore_n,0),NVL(valore_n_1,0))';



CREATE INDEX IE1_PBANDI_T_DETT_PROPOSTA_REV ON PBANDI_T_DETT_PROPOSTA_REV
(ID_PROPOSTA_CERTIFICAZ)
TABLESPACE PBANDI_IDX;


CREATE INDEX IE2_PBANDI_T_DETT_PROPOSTA_REV ON PBANDI_T_DETT_PROPOSTA_REV
(ID_PROGETTO, ID_PROPOSTA_CERTIFICAZ)
TABLESPACE PBANDI_IDX;


ALTER TABLE PBANDI_T_DETT_PROPOSTA_REV ADD (CONSTRAINT PK_PBANDI_T_DETT_PROPOSTA_REV
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_T_DETT_PROPOSTA_REV ADD (
  CONSTRAINT FK_PBANDI_C_PERC_SPESA_PUBB_03
  FOREIGN KEY (ID_LINEA_DI_INTERVENTO, NUM_PERC_SPESA_PUBBLICA) 
  REFERENCES PBANDI_C_PERC_SPESA_PUBBLICA (ID_LINEA_DI_INTERVENTO,NUM_PERC),
  CONSTRAINT FK_PBANDI_D_DIMENSIONE_IMPR_05
  FOREIGN KEY (ID_DIMENSIONE_IMPRESA) 
  REFERENCES PBANDI_D_DIMENSIONE_IMPRESA (ID_DIMENSIONE_IMPRESA),
  CONSTRAINT FK_PBANDI_D_LINEA_INTERV_59 
  FOREIGN KEY (ID_LINEA_DI_INTERVENTO) 
  REFERENCES PBANDI_D_LINEA_DI_INTERVENTO (ID_LINEA_DI_INTERVENTO),
  CONSTRAINT FK_PBANDI_D_STATO_PROGETTO_04
  FOREIGN KEY (ID_STATO_PROGETTO) 
  REFERENCES PBANDI_D_STATO_PROGETTO (ID_STATO_PROGETTO),
  CONSTRAINT FK_PBANDI_D_TIPO_OPERAZIONE_08 
  FOREIGN KEY (ID_TIPO_OPERAZIONE) 
  REFERENCES PBANDI_D_TIPO_OPERAZIONE (ID_TIPO_OPERAZIONE),
  CONSTRAINT FK_PBANDI_T_ENTE_GIURIDICO_07 
  FOREIGN KEY (ID_ENTE_GIURIDICO) 
  REFERENCES PBANDI_T_ENTE_GIURIDICO (ID_ENTE_GIURIDICO),
  CONSTRAINT FK_PBANDI_T_INDIRIZZO_16
  FOREIGN KEY (ID_INDIRIZZO_SEDE_LEGALE) 
  REFERENCES PBANDI_T_INDIRIZZO (ID_INDIRIZZO),
  CONSTRAINT FK_PBANDI_T_PERSONA_FISICA_08
  FOREIGN KEY (ID_PERSONA_FISICA) 
  REFERENCES PBANDI_T_PERSONA_FISICA (ID_PERSONA_FISICA),
  CONSTRAINT FK_PBANDI_T_PROGETTO_50
  FOREIGN KEY (ID_PROGETTO) 
  REFERENCES PBANDI_T_PROGETTO (ID_PROGETTO),
  CONSTRAINT FK_PBANDI_T_PROPOSTA_CERTIF_13 
  FOREIGN KEY (ID_PROPOSTA_CERTIFICAZ) 
  REFERENCES PBANDI_T_PROPOSTA_CERTIFICAZ (ID_PROPOSTA_CERTIFICAZ),
  CONSTRAINT FK_PBANDI_T_UTENTE_272 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_273
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL);
  
--  PBANDI_R_DET_PROP_CER_CHECKLIS
CREATE TABLE PBANDI_R_DET_PROP_REV_CHECKLIS
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_CHECKLIST             NUMBER(8)            NOT NULL,
  VERSIONE                 NUMBER(3),
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DET_PROP_REV_CHECKLIS ADD (
  CONSTRAINT PK_PBANDI_R_DET_PROP_REV_CHECK
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_CHECKLIST)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DET_PROP_REV_CHECKLIS ADD (
  CONSTRAINT FK_PBANDI_T_CHECKLIST_05
  FOREIGN KEY (ID_CHECKLIST) 
  REFERENCES PBANDI_T_CHECKLIST (ID_CHECKLIST),
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_01
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_UTENTE_274
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_275 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));

--  PBANDI_R_DET_PROP_CER_MAND_QUI
CREATE TABLE PBANDI_R_DET_PROP_REV_MAND_QUI
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_MANDATO_QUIETANZATO   NUMBER(8)            NOT NULL,
  IMPORTO_QUIETANZATO      NUMBER(15,2),
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DET_PROP_REV_MAND_QUI ADD (
  CONSTRAINT PK_PBANDI_R_DET_PROP_REV_MAND_
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_MANDATO_QUIETANZATO)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DET_PROP_REV_MAND_QUI ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_02 
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_MANDATO_QUIETAN_02
  FOREIGN KEY (ID_MANDATO_QUIETANZATO) 
  REFERENCES PBANDI_T_MANDATO_QUIETANZATO (ID_MANDATO_QUIETANZATO),
  CONSTRAINT FK_PBANDI_T_UTENTE_276 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_277 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));

--PBANDI_R_DET_PROP_CER_QP_DOC  
CREATE TABLE PBANDI_R_DET_PROP_REV_QP_DOC
(
  ID_DETT_PROPOSTA_CERTIF      NUMBER(8)        NOT NULL,
  PROGR_PAG_QUOT_PARTE_DOC_SP  NUMBER(8)        NOT NULL,
  IMPORTO_DOCUMENTO            NUMBER(13,2)     NOT NULL,
  IMPORTO_UTILIZZATO           NUMBER(13,2)     NOT NULL,
  ID_UTENTE_INS                NUMBER(8)        NOT NULL,
  ID_UTENTE_AGG                NUMBER(8),
  ID_DICHIARAZIONE_SPESA       NUMBER(8)        NOT NULL,
  IMPORTO_VALIDATO_RETT        NUMBER(17,2)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DET_PROP_REV_QP_DOC ADD (
  CONSTRAINT PK_PBANDI_R_DET_PROP_REV_QP_DO
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, PROGR_PAG_QUOT_PARTE_DOC_SP)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DET_PROP_REV_QP_DOC ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_03
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_UTENTE_278 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_279 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL);

--PBANDI_R_DET_PROP_CER_SOGG_FIN  
CREATE TABLE PBANDI_R_DET_PROP_REV_SOGG_FIN
(
  ID_DETT_PROPOSTA_CERTIF      NUMBER(8)        NOT NULL,
  ID_TIPO_SOGG_FINANZIAT       NUMBER(3)        NOT NULL,
  PERC_TIPO_SOGG_FINANZIATORE  NUMBER(5,2)      NOT NULL,
  ID_UTENTE_INS                NUMBER(8)        NOT NULL,
  ID_UTENTE_AGG                NUMBER(8),
  PERC_TIPO_SOGG_FINANZ_FESR   NUMBER(5,2),
  IMP_QUOTA_SOGG_FINANZIATORE  NUMBER(13,2)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DET_PROP_REV_SOGG_FIN ADD (
  CONSTRAINT PK_PBANDI_R_DET_PROP_REV_SOGG_
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_TIPO_SOGG_FINANZIAT)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DET_PROP_REV_SOGG_FIN ADD (
  CONSTRAINT FK_PBANDI_D_TIPO_SOGG_FINAN_06
  FOREIGN KEY (ID_TIPO_SOGG_FINANZIAT) 
  REFERENCES PBANDI_D_TIPO_SOGG_FINANZIAT (ID_TIPO_SOGG_FINANZIAT),
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_04
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_UTENTE_280 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_281 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL);

--PBANDI_R_DET_PROP_IND_SEDE_INT
CREATE TABLE PBANDI_R_DET_PROP_REV_SEDE_INT
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_INDIRIZZO             NUMBER(9)            NOT NULL,
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DET_PROP_REV_SEDE_INT ADD (
  CONSTRAINT PK_PBANDI_R_DET_PROP_REV_SEDE_
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_INDIRIZZO)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DET_PROP_REV_SEDE_INT ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_05
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_INDIRIZZO_17
  FOREIGN KEY (ID_INDIRIZZO) 
  REFERENCES PBANDI_T_INDIRIZZO (ID_INDIRIZZO),
  CONSTRAINT FK_PBANDI_T_UTENTE_282 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_283 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));

--  PBANDI_R_DETT_PROP_CER_FIDEIUS
 CREATE TABLE PBANDI_R_DETT_PROP_REV_FIDEIUS
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_FIDEIUSSIONE          NUMBER(8)            NOT NULL,
  IMPORTO_DOCUMENTO        NUMBER(13,2)         NOT NULL,
  IMPORTO_UTILIZZATO       NUMBER(13,2)         NOT NULL,
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8)
)
TABLESPACE PBANDI_TBL;



ALTER TABLE PBANDI_R_DETT_PROP_REV_FIDEIUS ADD (
  CONSTRAINT PK_PBANDI_R_DETT_PROP_REV_FIDE
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_FIDEIUSSIONE)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DETT_PROP_REV_FIDEIUS ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_06 
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_FIDEIUSSIONE_03
  FOREIGN KEY (ID_FIDEIUSSIONE) 
  REFERENCES PBANDI_T_FIDEIUSSIONE (ID_FIDEIUSSIONE),
  CONSTRAINT FK_PBANDI_T_UTENTE_284 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_285 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL);

--  PBANDI_R_DETT_PROP_CER_LIN_ANT
 CREATE TABLE PBANDI_R_DETT_PROP_REV_LIN_ANT
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_LINEA_DI_INTERVENTO   NUMBER(3)            NOT NULL,
  IMPORTO_ANTICIPO         NUMBER(17,2)         NOT NULL,
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DETT_PROP_REV_LIN_ANT ADD (
  CONSTRAINT PK_PBANDI_R_DETT_PROP_REV_L_AN
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_LINEA_DI_INTERVENTO)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DETT_PROP_REV_LIN_ANT ADD (
  CONSTRAINT FK_PBANDI_D_LINEA_INTERV_60
  FOREIGN KEY (ID_LINEA_DI_INTERVENTO) 
  REFERENCES PBANDI_D_LINEA_DI_INTERVENTO (ID_LINEA_DI_INTERVENTO),
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_07
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_UTENTE_286 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_287 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));

--  PBANDI_R_DETT_PROP_CERT_EROGAZ
 CREATE TABLE PBANDI_R_DETT_PROP_REV_EROGAZ
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_EROGAZIONE            NUMBER(8)            NOT NULL,
  IMPORTO_DOCUMENTO        NUMBER(13,2)         NOT NULL,
  IMPORTO_UTILIZZATO       NUMBER(13,2)         NOT NULL,
  ID_UTENTE_INS            NUMBER(8),
  ID_UTENTE_AGG            NUMBER(8),
  ID_PROGETTO_PERCETTORE   NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DETT_PROP_REV_EROGAZ ADD (
  CONSTRAINT PK_PBANDI_R_DETT_PROP_REV_ERO
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_EROGAZIONE)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DETT_PROP_REV_EROGAZ ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_08
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_EROGAZIONE_03
  FOREIGN KEY (ID_EROGAZIONE) 
  REFERENCES PBANDI_T_EROGAZIONE (ID_EROGAZIONE),
  CONSTRAINT FK_PBANDI_T_PROGETTO_51 
  FOREIGN KEY (ID_PROGETTO_PERCETTORE) 
  REFERENCES PBANDI_T_PROGETTO (ID_PROGETTO),
  CONSTRAINT FK_PBANDI_T_UTENTE_288 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL,
  CONSTRAINT FK_PBANDI_T_UTENTE_289
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL);

--PBANDI_R_DETT_PROP_CERT_REVOCA  
CREATE TABLE PBANDI_R_DETT_PROP_REV_REVOCA
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  IMPORTO_DOCUMENTO        NUMBER(17,2)         NOT NULL,
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8),
  ID_REVOCA                NUMBER(8)            NOT NULL,
  ID_PROGETTO_PERCETTORE   NUMBER(8),
  QUOTA_REVOCA_PER_IRR     NUMBER(17,2)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DETT_PROP_REV_REVOCA ADD (
  CONSTRAINT PK_PBANDI_R_DETT_PROP_REV_REV
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_REVOCA)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DETT_PROP_REV_REVOCA ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_09
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_PROGETTO_52 
  FOREIGN KEY (ID_PROGETTO_PERCETTORE) 
  REFERENCES PBANDI_T_PROGETTO (ID_PROGETTO),
  CONSTRAINT FK_PBANDI_T_REVOCA_04
  FOREIGN KEY (ID_REVOCA) 
  REFERENCES PBANDI_T_REVOCA (ID_REVOCA),
  CONSTRAINT FK_PBANDI_T_UTENTE_290 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_291 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));
  
--PBANDI_R_DETT_PROP_CERTIF_RECU
CREATE TABLE PBANDI_R_DETT_PROP_REV_RECU
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_RECUPERO              NUMBER(8)            NOT NULL,
  IMPORTO_DOCUMENTO        NUMBER(17,2)         NOT NULL,
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8),
  ID_TIPO_RECUPERO         NUMBER(3)            NOT NULL,
  INTERESSI_RECUPERO       NUMBER(13,2),
  ID_PROGETTO_PERCETTORE   NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DETT_PROP_REV_RECU ADD (
  CONSTRAINT PK_PBANDI_R_DETT_PROP_REV_R
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_RECUPERO)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DETT_PROP_REV_RECU ADD (
  CONSTRAINT FK_PBANDI_D_TIPO_RECUPERO_04
  FOREIGN KEY (ID_TIPO_RECUPERO) 
  REFERENCES PBANDI_D_TIPO_RECUPERO (ID_TIPO_RECUPERO),
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_10 
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_PROGETTO_53 
  FOREIGN KEY (ID_PROGETTO_PERCETTORE) 
  REFERENCES PBANDI_T_PROGETTO (ID_PROGETTO),
  CONSTRAINT FK_PBANDI_T_RECUPERO_02 
  FOREIGN KEY (ID_RECUPERO) 
  REFERENCES PBANDI_T_RECUPERO (ID_RECUPERO),
  CONSTRAINT FK_PBANDI_T_UTENTE_292 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_293 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));

--PBANDI_R_PROP_CERT_SCOST_ASSE  
CREATE TABLE PBANDI_R_PROP_REV_SCOST_ASSE
(
  ID_PROPOSTA_CERTIFICAZ  NUMBER(8)             NOT NULL,
  ID_LINEA_DI_INTERVENTO  NUMBER(3)             NOT NULL,
  ID_TIPO_SOGG_FINANZIAT  NUMBER(3)             NOT NULL,
  PERC_SCOSTAMENTO        NUMBER(5,2)           NOT NULL,
  VAL_ASS_SCOSTAMENTO     NUMBER(17,2)          NOT NULL,
  FLAG_COMP               CHAR(1)          DEFAULT 'N'                   NOT NULL
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_PROP_REV_SCOST_ASSE ADD (
  CONSTRAINT PK_PBANDI_R_PROP_REV_SCOST_AS
  PRIMARY KEY
  (ID_PROPOSTA_CERTIFICAZ, ID_LINEA_DI_INTERVENTO, ID_TIPO_SOGG_FINANZIAT)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_PROP_REV_SCOST_ASSE ADD (
  CONSTRAINT FK_PBANDI_D_LINEA_INTERV_62
  FOREIGN KEY (ID_LINEA_DI_INTERVENTO) 
  REFERENCES PBANDI_D_LINEA_DI_INTERVENTO (ID_LINEA_DI_INTERVENTO),
  CONSTRAINT FK_PBANDI_D_TIPO_SOGG_FINAN_08
  FOREIGN KEY (ID_TIPO_SOGG_FINANZIAT) 
  REFERENCES PBANDI_D_TIPO_SOGG_FINANZIAT (ID_TIPO_SOGG_FINANZIAT),
  CONSTRAINT FK_PBANDI_T_PROPOSTA_CERTIF_15
  FOREIGN KEY (ID_PROPOSTA_CERTIFICAZ) 
  REFERENCES PBANDI_T_PROPOSTA_CERTIFICAZ (ID_PROPOSTA_CERTIFICAZ));


INSERT INTO PBANDI_T_DETT_PROPOSTA_REV
select * 
from PBANDI_T_DETT_PROPOSTA_CERTIF
where (id_progetto,id_proposta_certificaz) IN
(
SELECT id_progetto,
       max(a.id_proposta_certificaz) id_proposta_certificaz_appr
FROM PBANDI_T_DETT_PROPOSTA_CERTIF  a
join PBANDI_T_PROPOSTA_CERTIFICAZ b on b.id_proposta_certificaz = a.id_proposta_certificaz and b.id_stato_proposta_certif = 6 --Approvata
group by id_progetto);