/*******************************************************************************
* Copyright Regione Piemonte - 2024
* SPDX-License-Identifier: EUPL-1.2
******************************************************************************/

--
CREATE INDEX IDX1_PBANDI_T_TRACCIAMENTO ON PBANDI_T_TRACCIAMENTO
(ID_OPERAZIONE)
TABLESPACE PBANDI_IDX;


CREATE INDEX IDX2_PBANDI_T_TRACCIAMENTO ON PBANDI_T_TRACCIAMENTO
(ID_UTENTE)
TABLESPACE PBANDI_IDX;

--

ALTER TABLE PBANDI_T_ESITO_CONTROLLI ADD 
(DATA_CAMPIONE DATE);
--
ALTER TABLE PBANDI_T_IRREGOLARITA  ADD 
(DATA_CAMPIONE DATE);
--
ALTER TABLE PBANDI_T_IRREGOLARITA_PROVV  ADD 
(DATA_CAMPIONE DATE);
--

--PBANDI_T_FOLDER
ALTER TABLE PBANDI_T_FOLDER ADD ID_PROGETTO  NUMBER(8);

ALTER TABLE PBANDI_T_FOLDER ADD
CONSTRAINT FK_PBANDI_T_PROGETTO_54
FOREIGN KEY (ID_PROGETTO) 
REFERENCES PBANDI_T_PROGETTO (ID_PROGETTO);

--INDEX
CREATE INDEX IE_PBANDI_T_FOLDER_02 ON PBANDI_T_FOLDER (ID_PROGETTO) TABLESPACE PBANDI_IDX;

-- BATCH PBAN-CHIUSURA-PROGETTI
Insert into PBANDI_D_NOME_BATCH
   (ID_NOME_BATCH, NOME_BATCH, DESC_BATCH)
 Values
   (25, 'PBAN-CHIUSURA-PROGETTI', 'Procedura per la chiusura massiva dei progetti');
   
Insert into PBANDI_D_NOME_BATCH
   (ID_NOME_BATCH, NOME_BATCH, DESC_BATCH)
 Values
   (26, 'PBAN-FOLDER-PROGETTI', 'Procedura per il popolamento del folder dei progetti per un beneficiario');



Insert into PBANDI_D_ERRORE_BATCH
   (CODICE_ERRORE, DESCRIZIONE)
 Values
   ('E179', 'Errore bloccante su Archivio File');

   
Insert into PBANDI_D_ERRORE_BATCH
   (CODICE_ERRORE, DESCRIZIONE)
 Values
   ('W098', 'Progetto non trovato per il numero fondo');
   
Insert into PBANDI_D_ERRORE_BATCH
   (CODICE_ERRORE, DESCRIZIONE)
 Values
   ('W099', 'Da processo il progetto non può essere chiuso');

Insert into PBANDI_D_ERRORE_BATCH
   (CODICE_ERRORE, DESCRIZIONE)
 Values
   ('W100', 'Errore chiusura attività CHIUSURA_PROGETTO');
   
Insert into PBANDI_D_ERRORE_BATCH
   (CODICE_ERRORE, DESCRIZIONE)
 Values
   ('E178', 'Procedura di chiusura massiva progetti conclusa con errori');

Insert into PBANDI_D_ERRORE_BATCH
   (CODICE_ERRORE, DESCRIZIONE)
 Values
   ('W101', 'Errore accesso dati per inizializalizazione Archivio File');

   
-- PBANDI_T_CHIUSURA_PROGETTI
CREATE TABLE PBANDI_T_CHIUSURA_PROGETTI
(COD_FONDO VARCHAR2(4),
 CODICE_PROGETTO VARCHAR2(100),
 DT_CHIUSURA  DATE NOT NULL,
 ID_PROCESSO_BATCH NUMBER,
 ID_PROGETTO NUMBER(8),
 FLAG_CHIUSO CHAR(1)  DEFAULT 'N' NOT NULL,
 DENOMINAZIONE_BENEFICIARIO VARCHAR2(500));
 
  --UK
ALTER TABLE PBANDI_T_CHIUSURA_PROGETTI  ADD 
(CONSTRAINT UK_PBANDI_T_CHIUSURA_PROGETTI  UNIQUE (COD_FONDO,CODICE_PROGETTO,ID_PROCESSO_BATCH)
USING INDEX TABLESPACE PBANDI_IDX);

-- CK
ALTER TABLE PBANDI_T_CHIUSURA_PROGETTI ADD (
  CONSTRAINT CHK_FLAG_CHIUSO
  CHECK (FLAG_CHIUSO IN ('N','S')));

ALTER TABLE PBANDI_T_CHIUSURA_PROGETTI ADD
CONSTRAINT FK_PBANDI_T_PROGETTO_55
FOREIGN KEY (ID_PROGETTO) 
REFERENCES PBANDI_T_PROGETTO (ID_PROGETTO);

ALTER TABLE PBANDI_T_CHIUSURA_PROGETTI ADD
CONSTRAINT FK_PBANDI_L_PROCESSO_BATCH_04
FOREIGN KEY (ID_PROCESSO_BATCH) 
REFERENCES PBANDI_L_PROCESSO_BATCH (ID_PROCESSO_BATCH);

CREATE INDEX IE_PBANDI_T_CHIUS_PROG_1 ON PBANDI_T_CHIUSURA_PROGETTI
(ID_PROGETTO)
TABLESPACE PBANDI_IDX;

--PBANDI_T_PERSONA_FISICA (Consenso all invio di comunicazioni)
ALTER TABLE PBANDI_T_UTENTE ADD FLAG_CONSENSO_MAIL VARCHAR2(1);
ALTER TABLE PBANDI_T_UTENTE ADD EMAIL_CONSENSO VARCHAR2(128);

ALTER TABLE PBANDI_T_UTENTE ADD (
  CONSTRAINT CHK_FLAG_CONSENSO_MAIL
  CHECK (FLAG_CONSENSO_MAIL IN ('S', 'N')));
  
COMMENT ON COLUMN PBANDI_T_UTENTE.FLAG_CONSENSO_MAIL IS 'Il soggetto ha dato/ non ha dato il consenso';

CREATE OR REPLACE FORCE VIEW PBANDI_V_PROGETTI_BANDO
(
   PROGR_BANDO_LINEA_INTERVENTO,
   ID_LINEA_DI_INTERVENTO,
   ID_PROGETTO,
   CODICE_PROGETTO,
   CODICE_VISUALIZZATO,
   DT_AGGIORNAMENTO,
   ID_DOMANDA,
   NUMERO_DOMANDA,
   ID_PROGETTO_FINANZ
)
AS
   SELECT c.progr_bando_linea_intervento,
          c.id_linea_di_intervento,
          a.id_progetto,
		  a.codice_progetto,
          a.codice_visualizzato,
          a.dt_aggiornamento,
          b.id_domanda,
          b.numero_domanda,
		  a.id_progetto_finanz
     FROM PBANDI_T_PROGETTO a,
          PBANDI_T_DOMANDA b,
          PBANDI_R_BANDO_LINEA_INTERVENT c
    WHERE b.id_domanda = a.id_domanda
          AND c.progr_bando_linea_intervento = b.progr_bando_linea_intervento;


--
--
------------------------------
------------------------------
-- REVISIONE CERTIFICAZIONE --
------------------------------
------------------------------

-------------------------------
-- CONTROLLI CERTIFICAZIONE OBJ
-------------------------------
CREATE OR REPLACE TYPE OBJCTRLCERTIF AS OBJECT
(
CODICE_VISUALIZZATO VARCHAR2(100),
ID_PROGETTO NUMBER(8),
ID_PROPOSTA_CERTIFICAZ NUMBER(8),
ID_UTENTE_INS NUMBER(8),
NOME_BANDO_LINEA VARCHAR2(255),
IMPORTO_EROGAZIONI NUMBER(13,2),
ID_TIPO_OPERAZIONE NUMBER(3),
ID_DOMANDA NUMBER(8),
PROGR_BANDO_LINEA_INTERVENTO NUMBER(8),
IMPORTO_PAGAMENTI_VALIDATI NUMBER(13,2),
ID_LINEA_DI_INTERVENTO NUMBER(3),
FLAG_SIF VARCHAR2(1),
PROGR_BANDO_LINEA_INTERV_SIF NUMBER(8),
ID_PROGETTO_FINANZ NUMBER(8)
)
/

CREATE OR REPLACE TYPE LISTCTRLCERTIF AS TABLE OF OBJCTRLCERTIF
/

----------------------------
-- CREA CERTIFICAZIONE OBJ
----------------------------

CREATE OR REPLACE TYPE OBJCREACERTIF AS OBJECT
(
ID_DETT_PROPOSTA_CERTIF NUMBER(8), 
ID_PROPOSTA_CERTIFICAZ NUMBER(8), 
COSTO_AMMESSO NUMBER(13,2),
IMPORTO_PAGAMENTI_VALIDATI  NUMBER(13,2),
IMPORTO_PAG_VALIDATI_ORIG  NUMBER(13,2), 
IMPORTO_EROGAZIONI NUMBER(13,2), 
IMPORTO_FIDEIUSSIONI NUMBER(13,2),
SPESA_CERTIFICABILE_LORDA NUMBER(13,2), 
ID_PROGETTO NUMBER(8), 
ID_UTENTE_INS NUMBER(8), 
ID_UTENTE_AGG NUMBER(8),
IMPORTO_ECCENDENZE_VALIDAZIONE NUMBER(13,2),
TITOLO_PROGETTO VARCHAR2(2000),
NOME_BANDO_LINEA VARCHAR2(255),
FLAG_CHECK_LIST_IN_LOCO VARCHAR(1),
FLAG_CHECK_LIST_CERTIFICAZIONE VARCHAR(1),
ID_STATO_PROGETTO NUMBER(3),
ID_TIPO_OPERAZIONE  NUMBER(3),
DT_ULTIMA_CHECKLIST_IN_LOCO DATE,
IMPORTO_RENDICONTATO NUMBER(17,2),
FLAG_ATTIVO VARCHAR(1),
ID_LINEA_DI_INTERVENTO NUMBER(3)
)
/

CREATE OR REPLACE TYPE LISTCREACERTIF AS TABLE OF OBJCREACERTIF
/

-------------------------------
-- CONTROLLI CERTIFICAZIONE TBL
-------------------------------

CREATE TABLE PBANDI_T_PREVIEW_DETT_PROP_REV
(
  id_preview_dett_prop_cer     NUMBER not null,
  nome_bando_linea             VARCHAR2(255) not null,
  codice_progetto              VARCHAR2(100) not null,
  denominazione_beneficiario   VARCHAR2(255) not null,
  importo_certificazione_netto NUMBER(17,2),
  importo_revoche              NUMBER(17,2),
  flag_attivo                  CHAR(1) not null,
  id_proposta_certificaz       NUMBER(8) not null,
  id_progetto                  NUMBER(8) not null,
  importo_pagamenti            NUMBER(17,2),
  id_utente_ins                NUMBER(8) not null,
  id_utente_agg                NUMBER(8),
  progr_bando_linea_intervento NUMBER(8) not null,
  id_soggetto_beneficiario     NUMBER(8) not null,
  id_linea_di_intervento       NUMBER(3)
);

create unique index pbandi.REV_PREVIEW_idx 
on pbandi.PBANDI_T_PREVIEW_DETT_PROP_REV 
( ID_PROPOSTA_CERTIFICAZ, ID_PROGETTO )
tablespace pbandi_idx;


----------------------------
-- CREA CERTIFICAZIONE TBL
----------------------------


--PBANDI_T_DETT_PROPOSTA_CERTIF
CREATE TABLE PBANDI_T_DETT_PROPOSTA_REV
(
  ID_DETT_PROPOSTA_CERTIF         NUMBER(8)     NOT NULL,
  ID_PROPOSTA_CERTIFICAZ          NUMBER(8)     NOT NULL,
  COSTO_AMMESSO                   NUMBER(13,2),
  IMPORTO_PAGAMENTI_VALIDATI      NUMBER(13,2),
  IMPORTO_EROGAZIONI              NUMBER(13,2),
  IMPORTO_FIDEIUSSIONI            NUMBER(13,2),
  SPESA_CERTIFICABILE_LORDA       NUMBER(13,2),
  ID_PROGETTO                     NUMBER(8)     NOT NULL,
  ID_UTENTE_INS                   NUMBER(8)     NOT NULL,
  ID_UTENTE_AGG                   NUMBER(8),
  IMPORTO_ECCENDENZE_VALIDAZIONE  NUMBER(13,2),
  IMPORTO_REVOCHE                 NUMBER(17,2),
  DT_ULTIMA_REVOCA                DATE,
  IMPORTO_DA_RECUPERARE           NUMBER(17,2),
  IMPORTO_PRERECUPERI             NUMBER(17,2),
  DT_ULTIMO_PRERECUPERO           DATE,
  IMPORTO_RECUPERI                NUMBER(17,2),
  DT_ULTIMO_RECUPERO              DATE,
  IMPORTO_SOPPRESSIONI            NUMBER(17,2),
  DT_ULTIMA_SOPPRESSIONE          DATE,
  IMPORTO_NON_RILEVANTE_CERTIF    NUMBER(17,2),
  IMPORTO_CERTIFICAZIONE_NETTO    NUMBER(17,2),
  IDENTIFICATIVI_IRREGOLARITA     VARCHAR2(300),
  EROGAZIONI_IN_MENO_PER_ERRORE   NUMBER(17,2),
  FIDEIUSSIONI_IN_MENO_PER_ERROR  NUMBER(17,2),
  SOPPRESSIONI_IN_MENO_PER_ERROR  NUMBER(17,2),
  PRERECUPERI_IN_MENO_PER_ERROR   NUMBER(17,2),
  RECUPERI_IN_MENO_PER_ERRORE     NUMBER(17,2),
  REVOCHE_IN_MENO_PER_ERROR       NUMBER(17,2),
  FLAG_COMP                       CHAR(1)  DEFAULT 'N'                   NOT NULL,
  TITOLO_PROGETTO                 VARCHAR2(2000),
  NOME_BANDO_LINEA                VARCHAR2(255),
  CONTRIBUTO_PUBBLICO_CONCESSO    NUMBER(17,2),
  FLAG_CHECK_LIST_IN_LOCO         CHAR(1)  DEFAULT 'N'                   NOT NULL,
  FLAG_CHECK_LIST_CERTIFICAZIONE  CHAR(1)  DEFAULT 'N'                   NOT NULL,
  ID_STATO_PROGETTO               NUMBER(3),
  ID_TIPO_OPERAZIONE              NUMBER(3),
  ID_INDIRIZZO_SEDE_LEGALE        NUMBER(9),
  ID_PERSONA_FISICA               NUMBER(8),
  ID_ENTE_GIURIDICO               NUMBER(8),
  ID_DIMENSIONE_IMPRESA           NUMBER(3),
  DT_ULTIMA_CHECKLIST_IN_LOCO     DATE,
  IMPORTO_RENDICONTATO            NUMBER(17,2),
  IMPORTO_INTERESSI_RECUPERATI    NUMBER(17,2),
  IMP_INTERESSI_RECUPERATI_NETTI  NUMBER(17,2),
  IMP_CERTIFICABILE_NETTO_SOPPR   NUMBER(17,2),
  IMP_REVOCHE_NETTO_SOPPRESSIONI  NUMBER(17,2),
  IMP_CERTIFICABILE_NETTO_REVOC   NUMBER(17,2),
  IMPORTO_REVOCHE_INTERMEDIO      NUMBER(17,2),
  IMP_CERTIFICAZIONE_NETTO_PREC   NUMBER(17,2),
  AVANZAMENTO                     NUMBER(17,2),
  IMPORTO_SOPPRESSIONI_NETTO      NUMBER(17,2),
  IMPORTO_RECUPERI_PRERECUPERI    NUMBER(17,2),
  FLAG_ATTIVO                     CHAR(1)  DEFAULT 'S'                   NOT NULL,
  FLAG_CORREZIONE_CN              CHAR(1)  DEFAULT 'N'                   NOT NULL,
  ID_LINEA_DI_INTERVENTO          NUMBER(3),
  IMP_CERTIFICAZIONE_NETTO_BCK    NUMBER(17,2),
  IMP_CERTIF_NETTO_PREMODIFICA    NUMBER(17,2),
  CODICE_PROGETTO                 VARCHAR2(100),
  DENOMINAZIONE_BENEFICIARIO      VARCHAR2(255),
  NOTA                            VARCHAR2(4000),
  QUOTA_REVOCA_PER_IRR            NUMBER(17,2),
  NUM_PERC_SPESA_PUBBLICA         NUMBER(3),
  IMPORTO_CERT_NET_ANNO_PREC      NUMBER(13,2),
  IMPORTO_CERT_NET_ANNO_IN_CORSO  NUMBER(13,2),
  IMPORTO_CERT_NET_ANNI_PREC      NUMBER(13,2),
  IMPORTO_PAG_VALIDATI_ORIG       NUMBER(13,2),
  VALORE_N                        NUMBER(17,2),
  VALORE_N_1                      NUMBER(17,2),
  SOMMA_VALORI_N                  NUMBER(17,2)
)
TABLESPACE PBANDI_TBL;

COMMENT ON COLUMN PBANDI_T_DETT_PROPOSTA_REV.IMP_CERTIFICAZIONE_NETTO_BCK IS 'Backup del valore della colonna IMPORTO_CERTIFICATO_NETTO quando questo Ã¨ negativo';

COMMENT ON COLUMN PBANDI_T_DETT_PROPOSTA_REV.IMP_CERTIF_NETTO_PREMODIFICA IS 'Importo certificazione netto calcolato dalla procedura e non modificabile da on-line';

COMMENT ON COLUMN PBANDI_T_DETT_PROPOSTA_REV.SOMMA_VALORI_N IS 'DERIVA DALLA SEGUENTE FORMULA --> somma_valori_n = GREATEST (NVL(valore_n,0),NVL(valore_n_1,0))';



CREATE INDEX IE1_PBANDI_T_DETT_PROPOSTA_REV ON PBANDI_T_DETT_PROPOSTA_REV
(ID_PROPOSTA_CERTIFICAZ)
TABLESPACE PBANDI_IDX;


CREATE INDEX IE2_PBANDI_T_DETT_PROPOSTA_REV ON PBANDI_T_DETT_PROPOSTA_REV
(ID_PROGETTO, ID_PROPOSTA_CERTIFICAZ)
TABLESPACE PBANDI_IDX;


ALTER TABLE PBANDI_T_DETT_PROPOSTA_REV ADD (CONSTRAINT PK_PBANDI_T_DETT_PROPOSTA_REV
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_T_DETT_PROPOSTA_REV ADD (
  CONSTRAINT FK_PBANDI_C_PERC_SPESA_PUBB_03
  FOREIGN KEY (ID_LINEA_DI_INTERVENTO, NUM_PERC_SPESA_PUBBLICA) 
  REFERENCES PBANDI_C_PERC_SPESA_PUBBLICA (ID_LINEA_DI_INTERVENTO,NUM_PERC),
  CONSTRAINT FK_PBANDI_D_DIMENSIONE_IMPR_05
  FOREIGN KEY (ID_DIMENSIONE_IMPRESA) 
  REFERENCES PBANDI_D_DIMENSIONE_IMPRESA (ID_DIMENSIONE_IMPRESA),
  CONSTRAINT FK_PBANDI_D_LINEA_INTERV_59 
  FOREIGN KEY (ID_LINEA_DI_INTERVENTO) 
  REFERENCES PBANDI_D_LINEA_DI_INTERVENTO (ID_LINEA_DI_INTERVENTO),
  CONSTRAINT FK_PBANDI_D_STATO_PROGETTO_04
  FOREIGN KEY (ID_STATO_PROGETTO) 
  REFERENCES PBANDI_D_STATO_PROGETTO (ID_STATO_PROGETTO),
  CONSTRAINT FK_PBANDI_D_TIPO_OPERAZIONE_08 
  FOREIGN KEY (ID_TIPO_OPERAZIONE) 
  REFERENCES PBANDI_D_TIPO_OPERAZIONE (ID_TIPO_OPERAZIONE),
  CONSTRAINT FK_PBANDI_T_ENTE_GIURIDICO_07 
  FOREIGN KEY (ID_ENTE_GIURIDICO) 
  REFERENCES PBANDI_T_ENTE_GIURIDICO (ID_ENTE_GIURIDICO),
  CONSTRAINT FK_PBANDI_T_INDIRIZZO_16
  FOREIGN KEY (ID_INDIRIZZO_SEDE_LEGALE) 
  REFERENCES PBANDI_T_INDIRIZZO (ID_INDIRIZZO),
  CONSTRAINT FK_PBANDI_T_PERSONA_FISICA_08
  FOREIGN KEY (ID_PERSONA_FISICA) 
  REFERENCES PBANDI_T_PERSONA_FISICA (ID_PERSONA_FISICA),
  CONSTRAINT FK_PBANDI_T_PROGETTO_50
  FOREIGN KEY (ID_PROGETTO) 
  REFERENCES PBANDI_T_PROGETTO (ID_PROGETTO),
  CONSTRAINT FK_PBANDI_T_PROPOSTA_CERTIF_13 
  FOREIGN KEY (ID_PROPOSTA_CERTIFICAZ) 
  REFERENCES PBANDI_T_PROPOSTA_CERTIFICAZ (ID_PROPOSTA_CERTIFICAZ),
  CONSTRAINT FK_PBANDI_T_UTENTE_272 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_273
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL);
  
--  PBANDI_R_DET_PROP_CER_CHECKLIS
CREATE TABLE PBANDI_R_DET_PROP_REV_CHECKLIS
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_CHECKLIST             NUMBER(8)            NOT NULL,
  VERSIONE                 NUMBER(3),
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DET_PROP_REV_CHECKLIS ADD (
  CONSTRAINT PK_PBANDI_R_DET_PROP_REV_CHECK
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_CHECKLIST)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DET_PROP_REV_CHECKLIS ADD (
  CONSTRAINT FK_PBANDI_T_CHECKLIST_05
  FOREIGN KEY (ID_CHECKLIST) 
  REFERENCES PBANDI_T_CHECKLIST (ID_CHECKLIST),
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_01
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_UTENTE_274
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_275 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));

--  PBANDI_R_DET_PROP_CER_MAND_QUI
CREATE TABLE PBANDI_R_DET_PROP_REV_MAND_QUI
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_MANDATO_QUIETANZATO   NUMBER(8)            NOT NULL,
  IMPORTO_QUIETANZATO      NUMBER(15,2),
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DET_PROP_REV_MAND_QUI ADD (
  CONSTRAINT PK_PBANDI_R_DET_PROP_REV_MAND_
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_MANDATO_QUIETANZATO)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DET_PROP_REV_MAND_QUI ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_02 
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_MANDATO_QUIETAN_02
  FOREIGN KEY (ID_MANDATO_QUIETANZATO) 
  REFERENCES PBANDI_T_MANDATO_QUIETANZATO (ID_MANDATO_QUIETANZATO),
  CONSTRAINT FK_PBANDI_T_UTENTE_276 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_277 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));

--PBANDI_R_DET_PROP_CER_QP_DOC  
CREATE TABLE PBANDI_R_DET_PROP_REV_QP_DOC
(
  ID_DETT_PROPOSTA_CERTIF      NUMBER(8)        NOT NULL,
  PROGR_PAG_QUOT_PARTE_DOC_SP  NUMBER(8)        NOT NULL,
  IMPORTO_DOCUMENTO            NUMBER(13,2)     NOT NULL,
  IMPORTO_UTILIZZATO           NUMBER(13,2)     NOT NULL,
  ID_UTENTE_INS                NUMBER(8)        NOT NULL,
  ID_UTENTE_AGG                NUMBER(8),
  ID_DICHIARAZIONE_SPESA       NUMBER(8)        NOT NULL,
  IMPORTO_VALIDATO_RETT        NUMBER(17,2)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DET_PROP_REV_QP_DOC ADD (
  CONSTRAINT PK_PBANDI_R_DET_PROP_REV_QP_DO
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, PROGR_PAG_QUOT_PARTE_DOC_SP)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DET_PROP_REV_QP_DOC ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_03
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_UTENTE_278 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_279 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL);

--PBANDI_R_DET_PROP_CER_SOGG_FIN  
CREATE TABLE PBANDI_R_DET_PROP_REV_SOGG_FIN
(
  ID_DETT_PROPOSTA_CERTIF      NUMBER(8)        NOT NULL,
  ID_TIPO_SOGG_FINANZIAT       NUMBER(3)        NOT NULL,
  PERC_TIPO_SOGG_FINANZIATORE  NUMBER(5,2)      NOT NULL,
  ID_UTENTE_INS                NUMBER(8)        NOT NULL,
  ID_UTENTE_AGG                NUMBER(8),
  PERC_TIPO_SOGG_FINANZ_FESR   NUMBER(5,2),
  IMP_QUOTA_SOGG_FINANZIATORE  NUMBER(13,2)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DET_PROP_REV_SOGG_FIN ADD (
  CONSTRAINT PK_PBANDI_R_DET_PROP_REV_SOGG_
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_TIPO_SOGG_FINANZIAT)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DET_PROP_REV_SOGG_FIN ADD (
  CONSTRAINT FK_PBANDI_D_TIPO_SOGG_FINAN_06
  FOREIGN KEY (ID_TIPO_SOGG_FINANZIAT) 
  REFERENCES PBANDI_D_TIPO_SOGG_FINANZIAT (ID_TIPO_SOGG_FINANZIAT),
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_04
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_UTENTE_280 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_281 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL);

--PBANDI_R_DET_PROP_IND_SEDE_INT
CREATE TABLE PBANDI_R_DET_PROP_REV_SEDE_INT
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_INDIRIZZO             NUMBER(9)            NOT NULL,
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DET_PROP_REV_SEDE_INT ADD (
  CONSTRAINT PK_PBANDI_R_DET_PROP_REV_SEDE_
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_INDIRIZZO)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DET_PROP_REV_SEDE_INT ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_05
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_INDIRIZZO_17
  FOREIGN KEY (ID_INDIRIZZO) 
  REFERENCES PBANDI_T_INDIRIZZO (ID_INDIRIZZO),
  CONSTRAINT FK_PBANDI_T_UTENTE_282 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_283 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));

--  PBANDI_R_DETT_PROP_CER_FIDEIUS
 CREATE TABLE PBANDI_R_DETT_PROP_REV_FIDEIUS
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_FIDEIUSSIONE          NUMBER(8)            NOT NULL,
  IMPORTO_DOCUMENTO        NUMBER(13,2)         NOT NULL,
  IMPORTO_UTILIZZATO       NUMBER(13,2)         NOT NULL,
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8)
)
TABLESPACE PBANDI_TBL;



ALTER TABLE PBANDI_R_DETT_PROP_REV_FIDEIUS ADD (
  CONSTRAINT PK_PBANDI_R_DETT_PROP_REV_FIDE
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_FIDEIUSSIONE)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DETT_PROP_REV_FIDEIUS ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_06 
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_FIDEIUSSIONE_03
  FOREIGN KEY (ID_FIDEIUSSIONE) 
  REFERENCES PBANDI_T_FIDEIUSSIONE (ID_FIDEIUSSIONE),
  CONSTRAINT FK_PBANDI_T_UTENTE_284 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_285 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL);

--  PBANDI_R_DETT_PROP_CER_LIN_ANT
 CREATE TABLE PBANDI_R_DETT_PROP_REV_LIN_ANT
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_LINEA_DI_INTERVENTO   NUMBER(3)            NOT NULL,
  IMPORTO_ANTICIPO         NUMBER(17,2)         NOT NULL,
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DETT_PROP_REV_LIN_ANT ADD (
  CONSTRAINT PK_PBANDI_R_DETT_PROP_REV_L_AN
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_LINEA_DI_INTERVENTO)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DETT_PROP_REV_LIN_ANT ADD (
  CONSTRAINT FK_PBANDI_D_LINEA_INTERV_60
  FOREIGN KEY (ID_LINEA_DI_INTERVENTO) 
  REFERENCES PBANDI_D_LINEA_DI_INTERVENTO (ID_LINEA_DI_INTERVENTO),
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_07
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_UTENTE_286 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_287 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));

--  PBANDI_R_DETT_PROP_CERT_EROGAZ
 CREATE TABLE PBANDI_R_DETT_PROP_REV_EROGAZ
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_EROGAZIONE            NUMBER(8)            NOT NULL,
  IMPORTO_DOCUMENTO        NUMBER(13,2)         NOT NULL,
  IMPORTO_UTILIZZATO       NUMBER(13,2)         NOT NULL,
  ID_UTENTE_INS            NUMBER(8),
  ID_UTENTE_AGG            NUMBER(8),
  ID_PROGETTO_PERCETTORE   NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DETT_PROP_REV_EROGAZ ADD (
  CONSTRAINT PK_PBANDI_R_DETT_PROP_REV_ERO
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_EROGAZIONE)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DETT_PROP_REV_EROGAZ ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_08
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_EROGAZIONE_03
  FOREIGN KEY (ID_EROGAZIONE) 
  REFERENCES PBANDI_T_EROGAZIONE (ID_EROGAZIONE),
  CONSTRAINT FK_PBANDI_T_PROGETTO_51 
  FOREIGN KEY (ID_PROGETTO_PERCETTORE) 
  REFERENCES PBANDI_T_PROGETTO (ID_PROGETTO),
  CONSTRAINT FK_PBANDI_T_UTENTE_288 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL,
  CONSTRAINT FK_PBANDI_T_UTENTE_289
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE)
  ON DELETE SET NULL);

--PBANDI_R_DETT_PROP_CERT_REVOCA  
CREATE TABLE PBANDI_R_DETT_PROP_REV_REVOCA
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  IMPORTO_DOCUMENTO        NUMBER(17,2)         NOT NULL,
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8),
  ID_REVOCA                NUMBER(8)            NOT NULL,
  ID_PROGETTO_PERCETTORE   NUMBER(8),
  QUOTA_REVOCA_PER_IRR     NUMBER(17,2)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DETT_PROP_REV_REVOCA ADD (
  CONSTRAINT PK_PBANDI_R_DETT_PROP_REV_REV
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_REVOCA)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DETT_PROP_REV_REVOCA ADD (
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_09
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_PROGETTO_52 
  FOREIGN KEY (ID_PROGETTO_PERCETTORE) 
  REFERENCES PBANDI_T_PROGETTO (ID_PROGETTO),
  CONSTRAINT FK_PBANDI_T_REVOCA_04
  FOREIGN KEY (ID_REVOCA) 
  REFERENCES PBANDI_T_REVOCA (ID_REVOCA),
  CONSTRAINT FK_PBANDI_T_UTENTE_290 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_291 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));
  
--PBANDI_R_DETT_PROP_CERTIF_RECU
CREATE TABLE PBANDI_R_DETT_PROP_REV_RECU
(
  ID_DETT_PROPOSTA_CERTIF  NUMBER(8)            NOT NULL,
  ID_RECUPERO              NUMBER(8)            NOT NULL,
  IMPORTO_DOCUMENTO        NUMBER(17,2)         NOT NULL,
  ID_UTENTE_INS            NUMBER(8)            NOT NULL,
  ID_UTENTE_AGG            NUMBER(8),
  ID_TIPO_RECUPERO         NUMBER(3)            NOT NULL,
  INTERESSI_RECUPERO       NUMBER(13,2),
  ID_PROGETTO_PERCETTORE   NUMBER(8)
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_DETT_PROP_REV_RECU ADD (
  CONSTRAINT PK_PBANDI_R_DETT_PROP_REV_R
  PRIMARY KEY
  (ID_DETT_PROPOSTA_CERTIF, ID_RECUPERO)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_DETT_PROP_REV_RECU ADD (
  CONSTRAINT FK_PBANDI_D_TIPO_RECUPERO_04
  FOREIGN KEY (ID_TIPO_RECUPERO) 
  REFERENCES PBANDI_D_TIPO_RECUPERO (ID_TIPO_RECUPERO),
  CONSTRAINT FK_PBANDI_T_DETT_PROP_REV_10 
  FOREIGN KEY (ID_DETT_PROPOSTA_CERTIF) 
  REFERENCES PBANDI_T_DETT_PROPOSTA_REV (ID_DETT_PROPOSTA_CERTIF),
  CONSTRAINT FK_PBANDI_T_PROGETTO_53 
  FOREIGN KEY (ID_PROGETTO_PERCETTORE) 
  REFERENCES PBANDI_T_PROGETTO (ID_PROGETTO),
  CONSTRAINT FK_PBANDI_T_RECUPERO_02 
  FOREIGN KEY (ID_RECUPERO) 
  REFERENCES PBANDI_T_RECUPERO (ID_RECUPERO),
  CONSTRAINT FK_PBANDI_T_UTENTE_292 
  FOREIGN KEY (ID_UTENTE_INS) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE),
  CONSTRAINT FK_PBANDI_T_UTENTE_293 
  FOREIGN KEY (ID_UTENTE_AGG) 
  REFERENCES PBANDI_T_UTENTE (ID_UTENTE));

--PBANDI_R_PROP_CERT_SCOST_ASSE  
CREATE TABLE PBANDI_R_PROP_REV_SCOST_ASSE
(
  ID_PROPOSTA_CERTIFICAZ  NUMBER(8)             NOT NULL,
  ID_LINEA_DI_INTERVENTO  NUMBER(3)             NOT NULL,
  ID_TIPO_SOGG_FINANZIAT  NUMBER(3)             NOT NULL,
  PERC_SCOSTAMENTO        NUMBER(5,2)           NOT NULL,
  VAL_ASS_SCOSTAMENTO     NUMBER(17,2)          NOT NULL,
  FLAG_COMP               CHAR(1)          DEFAULT 'N'                   NOT NULL
)
TABLESPACE PBANDI_TBL;


ALTER TABLE PBANDI_R_PROP_REV_SCOST_ASSE ADD (
  CONSTRAINT PK_PBANDI_R_PROP_REV_SCOST_AS
  PRIMARY KEY
  (ID_PROPOSTA_CERTIFICAZ, ID_LINEA_DI_INTERVENTO, ID_TIPO_SOGG_FINANZIAT)
  USING INDEX TABLESPACE PBANDI_IDX);

ALTER TABLE PBANDI_R_PROP_REV_SCOST_ASSE ADD (
  CONSTRAINT FK_PBANDI_D_LINEA_INTERV_62
  FOREIGN KEY (ID_LINEA_DI_INTERVENTO) 
  REFERENCES PBANDI_D_LINEA_DI_INTERVENTO (ID_LINEA_DI_INTERVENTO),
  CONSTRAINT FK_PBANDI_D_TIPO_SOGG_FINAN_08
  FOREIGN KEY (ID_TIPO_SOGG_FINANZIAT) 
  REFERENCES PBANDI_D_TIPO_SOGG_FINANZIAT (ID_TIPO_SOGG_FINANZIAT),
  CONSTRAINT FK_PBANDI_T_PROPOSTA_CERTIF_15
  FOREIGN KEY (ID_PROPOSTA_CERTIFICAZ) 
  REFERENCES PBANDI_T_PROPOSTA_CERTIFICAZ (ID_PROPOSTA_CERTIFICAZ));
 
  --vista
  CREATE OR REPLACE VIEW PBANDI_V_RILEVAZIONI AS
(SELECT DISTINCT
           --1 as n_query,
           ptp.ID_PERIODO,
           ptp.DESC_PERIODO_VISUALIZZATA,
           -- tc.ID_CAMPIONE,
           -- id normativa
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_NORMATIVA,
           -- normativa
           (    SELECT DESC_BREVE_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
                CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              NORMATIVA,
           -- id asse
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_ASSE,
           --asse
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ASSE,
           -- id misura
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_MISURA,
           --misura
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              MISURA,
           --id linea
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_AZIONE,
           -- linea
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              AZIONE,
           bli.PROGR_BANDO_LINEA_INTERVENTO,
           rc.ID_PROGETTO,
           bli.NOME_BANDO_LINEA,
           tp.CODICE_VISUALIZZATO,
           dca.ID_CATEG_ANAGRAFICA,
           dca.DESC_CATEG_ANAGRAFICA,
           teg.DENOMINAZIONE_ENTE_GIURIDICO,
           ti.data_campione DATA_CAMPIONAMENTO,
           tc.TIPO_CONTROLLI,
           ti.ID_IRREGOLARITA,
           ti.ID_IRREGOLARITA_PROVV AS ID_IRREGOLARITA_COLLEG_PROVV,
           ti.DATA_INIZIO_CONTROLLI,
           ti.DATA_FINE_CONTROLLI,
           tip.ID_IRREGOLARITA_PROVV AS ID_IRREGOLARITA_PROVV,              --
           tip.DATA_INIZIO_CONTROLLI AS DATA_INIZIO_CONTROLLI_PROVV,        --
           tip.DATA_FINE_CONTROLLI AS DATA_FINE_CONTROLLI_PROVV,            --
           tip.IRREGOLARITA_ANNULLATA AS IRREGOLARITA_ANNULLATA_PROVV,      --
           tip.IMPORTO_IRREGOLARITA AS IMPORTO_IRREGOLARITA_PROVV,          --
           tip.IMPORTO_AGEVOLAZIONE_IRREG AS IMPORTO_AGEVOL_IRREG_PROVV,    --
           tip.IMPORTO_IRREGOLARE_CERTIFICATO AS IMPORTO_IRREG_CERTIF_PROVV, --
           (SELECT DESC_MOTIVO_REVOCA
              FROM PBANDI_D_MOTIVO_REVOCA
             WHERE id_motivo_revoca = tip.id_motivo_revoca)
              AS DESC_MOTIVO_REVOCA_PROVV,
           ti.IMPORTO_IRREGOLARITA,
           ti.IMPORTO_AGEVOLAZIONE_IRREG,
           ti.QUOTA_IMP_IRREG_CERTIFICATO,
           mr.DESC_MOTIVO_REVOCA,
           ti.NUMERO_IMS,
           (dcd.DESC_CAUSALE_DISIMPEGNO || ' - ' || mr.DESC_MOTIVO_REVOCA)
              AS TIPO_PROVVEDIMENTO,
           tr.ESTREMI,
           tr.IMPORTO,
           (SELECT SUM (trp.IMPORTO_RECUPERO)
              FROM PBANDI_T_RECUPERO trp
             WHERE trp.ID_PROGETTO = rc.ID_PROGETTO)
              IMPORTO_RECUPERO,
           (SELECT MAX (trp.DT_RECUPERO)
              FROM PBANDI_T_RECUPERO trp
             WHERE trp.ID_PROGETTO = rc.ID_PROGETTO)
              DATA_RECUPERO,
           dmr.DESC_MANCATO_RECUPERO,
           NULL AS  ID_ESITO_CONTROLLO, --mc
           NULL AS  DT_INIZIO_CONTROLLI_REGOLARI, --mc
           NULL AS  DT_FINE_CONTROLLI_REGOLARI, --mc
           ti.NOTE AS NOTE_IRREGOLARITA, -- mc
           tip.NOTE AS  NOTE_IRREGOLARITA_PROVVISORIA, -- mc
           NULL AS NOTE_ESITO_REGOLARE --mc
      FROM PBANDI_T_CAMPIONAMENTO tc,
           PBANDI_R_CAMPIONAMENTO rc,
           PBANDI_T_PROGETTO tp,
           PBANDI_R_BANDO_LINEA_INTERVENT bli,
           PBANDI_T_DOMANDA td,
           PBANDI_T_PERIODO ptp,
           PBANDI_D_CATEG_ANAGRAFICA dca,
           PBANDI_R_SOGGETTO_PROGETTO rsp,
           PBANDI_T_ENTE_GIURIDICO teg,
           PBANDI_T_IRREGOLARITA ti,
           PBANDI_T_IRREGOLARITA_PROVV tip,
           PBANDI_D_MOTIVO_REVOCA mr,
           PBANDI_T_REVOCA tr,
           PBANDI_D_CAUSALE_DISIMPEGNO dcd,
           PBANDI_D_MANCATO_RECUPERO dmr,
           PBANDI_T_SOGGETTO ts,
           --PBANDI_T_RECUPERO trec,
           PBANDI_R_REVOCA_IRREG rri
     WHERE     ti.ID_IRREGOLARITA_PROVV = tip.ID_IRREGOLARITA_PROVV(+)
           AND tc.ID_CAMPIONE = rc.ID_CAMPIONE
           AND rc.ID_PROGETTO = tp.ID_PROGETTO
           AND tc.ID_PERIODO = ptp.ID_PERIODO
           AND tc.ID_CATEG_ANAGRAFICA = dca.ID_CATEG_ANAGRAFICA
           AND tp.ID_PROGETTO = rsp.ID_PROGETTO
           AND rsp.ID_ENTE_GIURIDICO = teg.ID_ENTE_GIURIDICO
           AND ts.ID_SOGGETTO = teg.id_SOGGETTO
           AND rsp.ID_TIPO_ANAGRAFICA = 1
           AND rsp.ID_TIPO_BENEFICIARIO <> 4
           AND tp.ID_PROGETTO = ti.ID_PROGETTO(+)
           -- AND tp.ID_PROGETTO = tip.ID_PROGETTO(+)
           --AND tp.ID_PROGETTO = trec.ID_PROGETTO(+)
           AND tr.ID_MOTIVO_REVOCA = mr.ID_MOTIVO_REVOCA(+)
           AND ti.ID_IRREGOLARITA = rri.ID_IRREGOLARITA(+)
           AND rri.ID_REVOCA = tr.ID_REVOCA(+)
           AND tr.ID_CAUSALE_DISIMPEGNO = dcd.ID_CAUSALE_DISIMPEGNO(+)
           AND tr.ID_MANCATO_RECUPERO = dmr.ID_MANCATO_RECUPERO(+)
           AND tp.ID_DOMANDA = td.ID_DOMANDA
           AND td.PROGR_BANDO_LINEA_INTERVENTO =
                  bli.PROGR_BANDO_LINEA_INTERVENTO
           AND ti.DT_FINE_VALIDITA IS NULL
           AND tc.id_categ_anagrafica = ti.id_categ_anagrafica -- mc
           AND tc.id_periodo = ti.id_periodo -- mc
           AND tc.tipo_controlli = ti.tipo_controlli -- mc
           -- DA NON FAR vedere se ha una provvisoria senza definitiva, questa casistica è gestita dalla seconda union , per evitare duplicazioni
           -- DA FAR vedere se ha la definitiva con la provvisoria collegata
           -- DA FAR vedere se la definitiva e la provvisoria non sono collegate ma sono validate entrambe (data fine null)
           AND (tp.id_progetto NOT IN
                   (SELECT DISTINCT id_progetto
                      FROM PBANDI_T_IRREGOLARITA_PROVV)
                AND tp.id_progetto IN (SELECT DISTINCT id_progetto
                                         FROM PBANDI_T_IRREGOLARITA
                                        WHERE DT_FINE_VALIDITA IS NULL)
                OR (tp.id_progetto IN
                       (SELECT DISTINCT ti.id_progetto
                          FROM PBANDI_T_IRREGOLARITA ti,
                               PBANDI_T_IRREGOLARITA_PROVV tip
                         WHERE ti.ID_IRREGOLARITA_PROVV =
                                  tip.ID_IRREGOLARITA_PROVV))
                OR (tp.id_progetto IN (SELECT DISTINCT ti.id_progetto
                                         FROM PBANDI_T_IRREGOLARITA ti
                                        WHERE ti.DT_FINE_VALIDITA IS NULL)
                    OR tp.id_progetto IN
                          (SELECT DISTINCT tip.id_progetto
                             FROM PBANDI_T_IRREGOLARITA_PROVV tip
                            WHERE tip.DT_FINE_VALIDITA IS NULL)))
    )
    UNION
    (SELECT DISTINCT -- progetti non campionati
          --1bis as n_query,
           ptp.ID_PERIODO,
           ptp.DESC_PERIODO_VISUALIZZATA,
           -- tc.ID_CAMPIONE,
           -- id normativa
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = ti.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_NORMATIVA,
           -- normativa
           (    SELECT DESC_BREVE_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
                CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = ti.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              NORMATIVA,
           -- id asse
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = ti.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_ASSE,
           --asse
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = ti.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ASSE,
           -- id misura
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = ti.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_MISURA,
           --misura
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = ti.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              MISURA,
           --id linea
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = ti.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_AZIONE,
           -- linea
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = ti.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              AZIONE,
           bli.PROGR_BANDO_LINEA_INTERVENTO,
           NVL(ti.ID_PROGETTO,tip.id_progetto) ID_PROGETTO,
           bli.NOME_BANDO_LINEA,
           tp.CODICE_VISUALIZZATO,
           dca.ID_CATEG_ANAGRAFICA,
           dca.DESC_CATEG_ANAGRAFICA,
           teg.DENOMINAZIONE_ENTE_GIURIDICO,
           ti.data_campione DATA_CAMPIONAMENTO,
           NVL (ti.tipo_controlli,tip.tipo_controlli) TIPO_CONTROLLI, -- tc.TIPO_CONTROLLI,
           ti.ID_IRREGOLARITA,
           ti.ID_IRREGOLARITA_PROVV AS ID_IRREGOLARITA_COLLEG_PROVV,
           ti.DATA_INIZIO_CONTROLLI,
           ti.DATA_FINE_CONTROLLI,
           tip.ID_IRREGOLARITA_PROVV AS ID_IRREGOLARITA_PROVV,              --
           tip.DATA_INIZIO_CONTROLLI AS DATA_INIZIO_CONTROLLI_PROVV,        --
           tip.DATA_FINE_CONTROLLI AS DATA_FINE_CONTROLLI_PROVV,            --
           tip.IRREGOLARITA_ANNULLATA AS IRREGOLARITA_ANNULLATA_PROVV,      --
           tip.IMPORTO_IRREGOLARITA AS IMPORTO_IRREGOLARITA_PROVV,          --
           tip.IMPORTO_AGEVOLAZIONE_IRREG AS IMPORTO_AGEVOL_IRREG_PROVV,    --
           tip.IMPORTO_IRREGOLARE_CERTIFICATO AS IMPORTO_IRREG_CERTIF_PROVV, --
           (SELECT DESC_MOTIVO_REVOCA
              FROM PBANDI_D_MOTIVO_REVOCA
             WHERE id_motivo_revoca = tip.id_motivo_revoca)
              AS DESC_MOTIVO_REVOCA_PROVV,
           ti.IMPORTO_IRREGOLARITA,
           ti.IMPORTO_AGEVOLAZIONE_IRREG,
           ti.QUOTA_IMP_IRREG_CERTIFICATO,
           mr.DESC_MOTIVO_REVOCA,
           ti.NUMERO_IMS,
           (dcd.DESC_CAUSALE_DISIMPEGNO || ' - ' || mr.DESC_MOTIVO_REVOCA)
              AS TIPO_PROVVEDIMENTO,
           tr.ESTREMI,
           tr.IMPORTO,
           (SELECT SUM (trp.IMPORTO_RECUPERO)
              FROM PBANDI_T_RECUPERO trp
             WHERE trp.ID_PROGETTO = ti.ID_PROGETTO)
              IMPORTO_RECUPERO,
           (SELECT MAX (trp.DT_RECUPERO)
              FROM PBANDI_T_RECUPERO trp
             WHERE trp.ID_PROGETTO = ti.ID_PROGETTO)
              DATA_RECUPERO,
           dmr.DESC_MANCATO_RECUPERO,
           NULL AS  ID_ESITO_CONTROLLO, --mc
           NULL AS  DT_INIZIO_CONTROLLI_REGOLARI, --mc
           NULL AS  DT_FINE_CONTROLLI_REGOLARI, --mc
           ti.NOTE AS NOTE_IRREGOLARITA, -- mc
           tip.NOTE AS  NOTE_IRREGOLARITA_PROVVISORIA, -- mc
           NULL AS NOTE_ESITO_REGOLARE --mc
      FROM --PBANDI_T_CAMPIONAMENTO tc,
           --PBANDI_R_CAMPIONAMENTO rc,
           PBANDI_T_PROGETTO tp,
           PBANDI_R_BANDO_LINEA_INTERVENT bli,
           PBANDI_T_DOMANDA td,
           PBANDI_T_PERIODO ptp,
           PBANDI_D_CATEG_ANAGRAFICA dca,
           PBANDI_R_SOGGETTO_PROGETTO rsp,
           PBANDI_T_ENTE_GIURIDICO teg,
           PBANDI_T_IRREGOLARITA ti,
           PBANDI_T_IRREGOLARITA_PROVV tip,
           PBANDI_D_MOTIVO_REVOCA mr,
           PBANDI_T_REVOCA tr,
           PBANDI_D_CAUSALE_DISIMPEGNO dcd,
           PBANDI_D_MANCATO_RECUPERO dmr,
           PBANDI_T_SOGGETTO ts,
           --PBANDI_T_RECUPERO trec,
           PBANDI_R_REVOCA_IRREG rri
     WHERE ti.ID_IRREGOLARITA_PROVV = tip.ID_IRREGOLARITA_PROVV(+)
           --AND tc.ID_CAMPIONE = rc.ID_CAMPIONE
           AND ti.ID_PROGETTO = tp.ID_PROGETTO --
           AND ti.ID_PERIODO = ptp.ID_PERIODO
           AND ti.ID_CATEG_ANAGRAFICA = dca.ID_CATEG_ANAGRAFICA
           AND tp.ID_PROGETTO = rsp.ID_PROGETTO
           AND rsp.ID_ENTE_GIURIDICO = teg.ID_ENTE_GIURIDICO
           AND ts.ID_SOGGETTO = teg.id_SOGGETTO
           AND rsp.ID_TIPO_ANAGRAFICA = 1
           AND rsp.ID_TIPO_BENEFICIARIO <> 4
           AND tp.ID_PROGETTO = ti.ID_PROGETTO(+)
           -- AND tp.ID_PROGETTO = tip.ID_PROGETTO(+)
           --AND tp.ID_PROGETTO = trec.ID_PROGETTO(+)
           AND tr.ID_MOTIVO_REVOCA = mr.ID_MOTIVO_REVOCA(+)
           AND ti.ID_IRREGOLARITA = rri.ID_IRREGOLARITA(+)
           AND rri.ID_REVOCA = tr.ID_REVOCA(+)
           AND tr.ID_CAUSALE_DISIMPEGNO = dcd.ID_CAUSALE_DISIMPEGNO(+)
           AND tr.ID_MANCATO_RECUPERO = dmr.ID_MANCATO_RECUPERO(+)
           AND tp.ID_DOMANDA = td.ID_DOMANDA
           AND td.PROGR_BANDO_LINEA_INTERVENTO =
                  bli.PROGR_BANDO_LINEA_INTERVENTO
           AND ti.DT_FINE_VALIDITA IS NULL
           -- AND tc.id_categ_anagrafica = ti.id_categ_anagrafica -- mc
           -- AND tc.id_periodo = ti.id_periodo -- mc
           -- AND tc.tipo_controlli = ti.tipo_controlli -- mc
           -- DA NON FAR vedere se ha una provvisoria senza definitiva, questa casistica è gestita dalla seconda union , per evitare duplicazioni
           -- DA FAR vedere se ha la definitiva con la provvisoria collegata
           -- DA FAR vedere se la definitiva e la provvisoria non sono collegate ma sono validate entrambe (data fine null)
           AND (tp.id_progetto NOT IN
                   (SELECT DISTINCT id_progetto
                      FROM PBANDI_T_IRREGOLARITA_PROVV)
                AND tp.id_progetto IN (SELECT DISTINCT id_progetto
                                         FROM PBANDI_T_IRREGOLARITA
                                        WHERE DT_FINE_VALIDITA IS NULL)
                OR (tp.id_progetto IN
                       (SELECT DISTINCT ti.id_progetto
                          FROM PBANDI_T_IRREGOLARITA ti,
                               PBANDI_T_IRREGOLARITA_PROVV tip
                         WHERE ti.ID_IRREGOLARITA_PROVV =
                                  tip.ID_IRREGOLARITA_PROVV))
                OR (tp.id_progetto IN (SELECT DISTINCT ti.id_progetto
                                         FROM PBANDI_T_IRREGOLARITA ti
                                        WHERE ti.DT_FINE_VALIDITA IS NULL)
                    OR tp.id_progetto IN
                          (SELECT DISTINCT tip.id_progetto
                             FROM PBANDI_T_IRREGOLARITA_PROVV tip
                            WHERE tip.DT_FINE_VALIDITA IS NULL)))
							)
    UNION
    (SELECT DISTINCT
         -- 2 as n_query,
           ptp.ID_PERIODO,
           ptp.DESC_PERIODO_VISUALIZZATA,
           -- tc.ID_CAMPIONE,
           -- id normativa
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_NORMATIVA,
           -- normativa
           (    SELECT DESC_BREVE_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              NORMATIVA,
           -- id asse
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_ASSE,
           --asse
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ASSE,
           -- id misura
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_MISURA,
           --misura
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              MISURA,
           --id linea
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_AZIONE,
           -- linea
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              AZIONE,
           bli.PROGR_BANDO_LINEA_INTERVENTO,
           rc.ID_PROGETTO,
           bli.NOME_BANDO_LINEA,
           tp.CODICE_VISUALIZZATO,
           dca.ID_CATEG_ANAGRAFICA,
           dca.DESC_CATEG_ANAGRAFICA,
           teg.DENOMINAZIONE_ENTE_GIURIDICO,
           tip.data_campione DATA_CAMPIONAMENTO, -- mc svuluppo settempre 2020
           tc.TIPO_CONTROLLI,
           NULL AS ID_IRREGOLARITA,
           NULL AS ID_IRREGOLARITA_COLLEG_PROVV,
           NULL AS DATA_INIZIO_CONTROLLI,
           NULL AS DATA_FINE_CONTROLLI,
           tip.ID_IRREGOLARITA_PROVV,
           tip.DATA_INIZIO_CONTROLLI AS DATA_INIZIO_CONTROLLI_PROVV,
           tip.DATA_FINE_CONTROLLI AS DATA_FINE_CONTROLLI_PROVV,
           tip.IRREGOLARITA_ANNULLATA AS IRREGOLARITA_ANNULLATA_PROVV,
           tip.IMPORTO_IRREGOLARITA AS IMPORTO_IRREGOLARITA_PROVV,
           tip.IMPORTO_AGEVOLAZIONE_IRREG AS IMPORTO_AGEVOL_IRREG_PROVV,
           tip.IMPORTO_IRREGOLARE_CERTIFICATO AS IMPORTO_IRREG_CERTIF_PROVV,
           mr.DESC_MOTIVO_REVOCA AS DESC_MOTIVO_REVOCA_PROVV,
           NULL AS IMPORTO_IRREGOLARITA,
           NULL AS IMPORTO_AGEVOLAZIONE_IRREG,
           NULL AS QUOTA_IMP_IRREG_CERTIFICATO,
           NULL AS DESC_MOTIVO_REVOCA,
           NULL AS NUMERO_IMS,
           NULL AS TIPO_PROVVEDIMENTO,
           NULL AS ESTREMI,
           NULL AS IMPORTO,
           NULL AS IMPORTO_RECUPERO,
           NULL AS DATA_RECUPERO,
           NULL AS DESC_MANCATO_RECUPERO,
           NULL AS ID_ESITO_CONTROLLO, --mc
           NULL AS  DT_INIZIO_CONTROLLI_REGOLARI, --mc
           NULL AS  DT_FINE_CONTROLLI_REGOLARI, --mc
           NULL AS NOTE_IRREGOLARITA, -- mc
           tip.NOTE AS  NOTE_IRREGOLARITA_PROVVISORIA, -- mc
           NULL AS NOTE_ESITO_REGOLARE --mc
      FROM PBANDI_T_CAMPIONAMENTO tc,
           PBANDI_R_CAMPIONAMENTO rc,
           PBANDI_T_PROGETTO tp,
           PBANDI_R_BANDO_LINEA_INTERVENT bli,
           PBANDI_T_DOMANDA td,
           PBANDI_T_PERIODO ptp,
           PBANDI_D_CATEG_ANAGRAFICA dca,
           PBANDI_R_SOGGETTO_PROGETTO rsp,
           PBANDI_T_ENTE_GIURIDICO teg,
           PBANDI_T_IRREGOLARITA_PROVV tip,
           PBANDI_D_MOTIVO_REVOCA mr,
           PBANDI_T_SOGGETTO ts
     WHERE     tc.ID_CAMPIONE = rc.ID_CAMPIONE
           AND rc.ID_PROGETTO = tp.ID_PROGETTO
           AND tc.ID_PERIODO = ptp.ID_PERIODO
           AND tc.ID_CATEG_ANAGRAFICA = dca.ID_CATEG_ANAGRAFICA
           AND tp.ID_PROGETTO = rsp.ID_PROGETTO
           AND rsp.ID_ENTE_GIURIDICO = teg.ID_ENTE_GIURIDICO
           AND ts.ID_SOGGETTO = teg.id_SOGGETTO
           AND rsp.ID_TIPO_ANAGRAFICA = 1
           AND rsp.ID_TIPO_BENEFICIARIO <> 4
           AND tp.ID_PROGETTO = tip.ID_PROGETTO(+)
           AND tip.ID_MOTIVO_REVOCA = mr.ID_MOTIVO_REVOCA(+)
           AND tp.ID_DOMANDA = td.ID_DOMANDA
           AND td.PROGR_BANDO_LINEA_INTERVENTO =
                  bli.PROGR_BANDO_LINEA_INTERVENTO
           AND tc.id_categ_anagrafica = tip.id_categ_anagrafica -- mc
           AND tc.id_periodo = tip.id_periodo -- mc
           AND tc.tipo_controlli = tip.tipo_controlli -- mc
           AND tip.ID_IRREGOLARITA_PROVV NOT IN
                  (SELECT ti.ID_IRREGOLARITA_PROVV
                     FROM PBANDI_T_IRREGOLARITA ti
                    WHERE     ti.DT_FINE_VALIDITA IS NULL
                          AND ID_PROGETTO = tp.ID_PROGETTO
                          AND ID_IRREGOLARITA_PROVV IS NOT NULL)
           AND tip.DT_FINE_VALIDITA IS NULL)
UNION
(SELECT DISTINCT
         -- 2bis as n_query, -- progetti non campionati
           ptp.ID_PERIODO,
           ptp.DESC_PERIODO_VISUALIZZATA,
           -- tc.ID_CAMPIONE,
           -- id normativa
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tip.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_NORMATIVA,
           -- normativa
           (    SELECT DESC_BREVE_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tip.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              NORMATIVA,
           -- id asse
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tip.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_ASSE,
           --asse
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tip.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ASSE,
           -- id misura
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tip.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_MISURA,
           --misura
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tip.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              MISURA,
           --id linea
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tip.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_AZIONE,
           -- linea
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tip.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              AZIONE,
           bli.PROGR_BANDO_LINEA_INTERVENTO,
           tip.ID_PROGETTO,
           bli.NOME_BANDO_LINEA,
           tp.CODICE_VISUALIZZATO,
           dca.ID_CATEG_ANAGRAFICA,
           dca.DESC_CATEG_ANAGRAFICA,
           teg.DENOMINAZIONE_ENTE_GIURIDICO,
           tip.data_campione DATA_CAMPIONAMENTO, -- mc svuluppo settempre 2020
           tip.TIPO_CONTROLLI,
           NULL AS ID_IRREGOLARITA,
           NULL AS ID_IRREGOLARITA_COLLEG_PROVV,
           NULL AS DATA_INIZIO_CONTROLLI,
           NULL AS DATA_FINE_CONTROLLI,
           tip.ID_IRREGOLARITA_PROVV,
           tip.DATA_INIZIO_CONTROLLI AS DATA_INIZIO_CONTROLLI_PROVV,
           tip.DATA_FINE_CONTROLLI AS DATA_FINE_CONTROLLI_PROVV,
           tip.IRREGOLARITA_ANNULLATA AS IRREGOLARITA_ANNULLATA_PROVV,
           tip.IMPORTO_IRREGOLARITA AS IMPORTO_IRREGOLARITA_PROVV,
           tip.IMPORTO_AGEVOLAZIONE_IRREG AS IMPORTO_AGEVOL_IRREG_PROVV,
           tip.IMPORTO_IRREGOLARE_CERTIFICATO AS IMPORTO_IRREG_CERTIF_PROVV,
           mr.DESC_MOTIVO_REVOCA AS DESC_MOTIVO_REVOCA_PROVV,
           NULL AS IMPORTO_IRREGOLARITA,
           NULL AS IMPORTO_AGEVOLAZIONE_IRREG,
           NULL AS QUOTA_IMP_IRREG_CERTIFICATO,
           NULL AS DESC_MOTIVO_REVOCA,
           NULL AS NUMERO_IMS,
           NULL AS TIPO_PROVVEDIMENTO,
           NULL AS ESTREMI,
           NULL AS IMPORTO,
           NULL AS IMPORTO_RECUPERO,
           NULL AS DATA_RECUPERO,
           NULL AS DESC_MANCATO_RECUPERO,
           NULL AS ID_ESITO_CONTROLLO, --mc
           NULL AS  DT_INIZIO_CONTROLLI_REGOLARI, --mc
           NULL AS  DT_FINE_CONTROLLI_REGOLARI, --mc
           NULL AS NOTE_IRREGOLARITA, -- mc
           tip.NOTE AS  NOTE_IRREGOLARITA_PROVVISORIA, -- mc
           NULL AS NOTE_ESITO_REGOLARE --mc
      FROM --PBANDI_T_CAMPIONAMENTO tc,
           --PBANDI_R_CAMPIONAMENTO rc,
           PBANDI_T_PROGETTO tp,
           PBANDI_R_BANDO_LINEA_INTERVENT bli,
           PBANDI_T_DOMANDA td,
           PBANDI_T_PERIODO ptp,
           PBANDI_D_CATEG_ANAGRAFICA dca,
           PBANDI_R_SOGGETTO_PROGETTO rsp,
           PBANDI_T_ENTE_GIURIDICO teg,
           PBANDI_T_IRREGOLARITA_PROVV tip,
           PBANDI_D_MOTIVO_REVOCA mr,
           PBANDI_T_SOGGETTO ts
     WHERE --tc.ID_CAMPIONE = rc.ID_CAMPIONE
           tip.ID_PROGETTO = tp.ID_PROGETTO
           AND tip.ID_PERIODO = ptp.ID_PERIODO
           AND tip.ID_CATEG_ANAGRAFICA = dca.ID_CATEG_ANAGRAFICA
           AND tp.ID_PROGETTO = rsp.ID_PROGETTO
           AND rsp.ID_ENTE_GIURIDICO = teg.ID_ENTE_GIURIDICO
           AND ts.ID_SOGGETTO = teg.id_SOGGETTO
           AND rsp.ID_TIPO_ANAGRAFICA = 1
           AND rsp.ID_TIPO_BENEFICIARIO <> 4
           AND tp.ID_PROGETTO = tip.ID_PROGETTO(+)
           AND tip.ID_MOTIVO_REVOCA = mr.ID_MOTIVO_REVOCA(+)
           AND tp.ID_DOMANDA = td.ID_DOMANDA
           AND td.PROGR_BANDO_LINEA_INTERVENTO =
                  bli.PROGR_BANDO_LINEA_INTERVENTO
           AND tip.id_categ_anagrafica = tip.id_categ_anagrafica -- mc
           AND tip.id_periodo = tip.id_periodo -- mc
           AND tip.tipo_controlli = tip.tipo_controlli -- mc
           AND tip.ID_IRREGOLARITA_PROVV NOT IN
                  (SELECT ti.ID_IRREGOLARITA_PROVV
                     FROM PBANDI_T_IRREGOLARITA ti
                    WHERE     ti.DT_FINE_VALIDITA IS NULL
                          AND ID_PROGETTO = tp.ID_PROGETTO
                          AND ID_IRREGOLARITA_PROVV IS NOT NULL)
           AND tip.DT_FINE_VALIDITA IS NULL
)
UNION
    -- esiti_regolari
    (SELECT DISTINCT
          -- 3 as n_query,
           ptp.ID_PERIODO,
           ptp.DESC_PERIODO_VISUALIZZATA,
           -- tc.ID_CAMPIONE,
           -- id normativa
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_NORMATIVA,
           -- normativa
           (    SELECT DESC_BREVE_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              NORMATIVA,
           -- id asse
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_ASSE,
           --asse
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ASSE,
           -- id misura
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_MISURA,
           --misura
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              MISURA,
           --id linea
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_AZIONE,
           -- linea
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              AZIONE,
           bli.PROGR_BANDO_LINEA_INTERVENTO,
           rc.ID_PROGETTO,
           bli.NOME_BANDO_LINEA,
           tp.CODICE_VISUALIZZATO,
           dca.ID_CATEG_ANAGRAFICA,
           dca.DESC_CATEG_ANAGRAFICA,
           teg.DENOMINAZIONE_ENTE_GIURIDICO,
           tec.data_campione DATA_CAMPIONAMENTO, -- mc svuluppo settempre 2020
           tc.TIPO_CONTROLLI,
           NULL AS ID_IRREGOLARITA,
           NULL AS ID_IRREGOLARITA_COLLEG_PROVV,
           NULL AS DATA_INIZIO_CONTROLLI,
           NULL AS DATA_FINE_CONTROLLI,
           NULL AS ID_IRREGOLARITA_PROVV,
           NULL AS  DATA_INIZIO_CONTROLLI_PROVV,
           NULL AS DATA_FINE_CONTROLLI_PROVV,
           NULL AS  IRREGOLARITA_ANNULLATA_PROVV,
           NULL AS IMPORTO_IRREGOLARITA_PROVV,
           NULL AS  IMPORTO_AGEVOL_IRREG_PROVV,
           NULL AS  IMPORTO_IRREG_CERTIF_PROVV,
           NULL AS  DESC_MOTIVO_REVOCA_PROVV,
           NULL AS IMPORTO_IRREGOLARITA,
           NULL AS IMPORTO_AGEVOLAZIONE_IRREG,
           NULL AS QUOTA_IMP_IRREG_CERTIFICATO,
           NULL AS DESC_MOTIVO_REVOCA,
           NULL AS NUMERO_IMS,
           NULL AS TIPO_PROVVEDIMENTO,
           NULL AS ESTREMI,
           NULL AS IMPORTO,
           NULL AS IMPORTO_RECUPERO,
           NULL AS DATA_RECUPERO,
           NULL AS DESC_MANCATO_RECUPERO,
           tec.ID_ESITO_CONTROLLO AS ID_ESITO_CONTROLLO, --mc
           tec.DATA_INIZIO_CONTROLLI AS  DT_INIZIO_CONTROLLI_REGOLARI, --mc
           tec.DATA_FINE_CONTROLLI AS  DT_FINE_CONTROLLI_REGOLARI, --mc
           NULL AS NOTE_IRREGOLARITA, -- mc
           NULL AS   NOTE_IRREGOLARITA_PROVVISORIA, -- mc
           tec.NOTE AS NOTE_ESITO_REGOLARE --mc
      FROM PBANDI_T_CAMPIONAMENTO tc,
           PBANDI_R_CAMPIONAMENTO rc,
           PBANDI_T_PROGETTO tp,
           PBANDI_R_BANDO_LINEA_INTERVENT bli,
           PBANDI_T_DOMANDA td,
           PBANDI_T_PERIODO ptp,
           PBANDI_D_CATEG_ANAGRAFICA dca,
           PBANDI_R_SOGGETTO_PROGETTO rsp,
           PBANDI_T_ENTE_GIURIDICO teg,
           PBANDI_T_SOGGETTO ts,
           PBANDI_T_ESITO_CONTROLLI tec
     WHERE  tc.ID_CAMPIONE = rc.ID_CAMPIONE
           AND rc.ID_PROGETTO = tp.ID_PROGETTO
           AND tp.ID_PROGETTO = tec.ID_PROGETTO -- mc
           AND tc.ID_PERIODO = ptp.ID_PERIODO
           AND tc.ID_CATEG_ANAGRAFICA = dca.ID_CATEG_ANAGRAFICA
           AND tp.ID_PROGETTO = rsp.ID_PROGETTO
           AND rsp.ID_ENTE_GIURIDICO = teg.ID_ENTE_GIURIDICO
           AND ts.ID_SOGGETTO = teg.id_SOGGETTO
           AND rsp.ID_TIPO_ANAGRAFICA = 1
           AND rsp.ID_TIPO_BENEFICIARIO <> 4
           AND tp.ID_DOMANDA = td.ID_DOMANDA
           AND td.PROGR_BANDO_LINEA_INTERVENTO =
                  bli.PROGR_BANDO_LINEA_INTERVENTO
           AND tc.id_categ_anagrafica = tec.id_categ_anagrafica -- mc
           AND tc.id_periodo = tec.id_periodo -- mc
           AND tc.tipo_controlli = tec.tipo_controlli
       UNION
       -- tutti i progetti con esito ma non campionati
       (SELECT DISTINCT
          -- 3BIS as n_query,
           ptp.ID_PERIODO,
           ptp.DESC_PERIODO_VISUALIZZATA,
           --ID_CAMPIONE,
           -- id normativa
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tec.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_NORMATIVA,
           -- normativa
           (    SELECT DESC_BREVE_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tec.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              NORMATIVA,
           -- id asse
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tec.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_ASSE,
           --asse
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tec.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ASSE,
           -- id misura
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tec.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_MISURA,
           --misura
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tec.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              MISURA,
           --id linea
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tec.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_AZIONE,
           -- linea
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = tec.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              AZIONE,
           bli.PROGR_BANDO_LINEA_INTERVENTO,
           tec.ID_PROGETTO,
           bli.NOME_BANDO_LINEA,
           tp.CODICE_VISUALIZZATO,
           dca.ID_CATEG_ANAGRAFICA,
           dca.DESC_CATEG_ANAGRAFICA,
           teg.DENOMINAZIONE_ENTE_GIURIDICO,
           tec.data_campione DATA_CAMPIONAMENTO, -- mc svuluppo settempre 2020
           tec.TIPO_CONTROLLI,
           NULL AS ID_IRREGOLARITA,
           NULL AS ID_IRREGOLARITA_COLLEG_PROVV,
           NULL AS DATA_INIZIO_CONTROLLI,
           NULL AS DATA_FINE_CONTROLLI,
           NULL AS ID_IRREGOLARITA_PROVV,
           NULL AS  DATA_INIZIO_CONTROLLI_PROVV,
           NULL AS DATA_FINE_CONTROLLI_PROVV,
           NULL AS  IRREGOLARITA_ANNULLATA_PROVV,
           NULL AS IMPORTO_IRREGOLARITA_PROVV,
           NULL AS  IMPORTO_AGEVOL_IRREG_PROVV,
           NULL AS  IMPORTO_IRREG_CERTIF_PROVV,
           NULL AS  DESC_MOTIVO_REVOCA_PROVV,
           NULL AS IMPORTO_IRREGOLARITA,
           NULL AS IMPORTO_AGEVOLAZIONE_IRREG,
           NULL AS QUOTA_IMP_IRREG_CERTIFICATO,
           NULL AS DESC_MOTIVO_REVOCA,
           NULL AS NUMERO_IMS,
           NULL AS TIPO_PROVVEDIMENTO,
           NULL AS ESTREMI,
           NULL AS IMPORTO,
           NULL AS IMPORTO_RECUPERO,
           NULL AS DATA_RECUPERO,
           NULL AS DESC_MANCATO_RECUPERO,
           tec.ID_ESITO_CONTROLLO AS ID_ESITO_CONTROLLO, --mc
           tec.DATA_INIZIO_CONTROLLI AS  DT_INIZIO_CONTROLLI_REGOLARI, --mc
           tec.DATA_FINE_CONTROLLI AS  DT_FINE_CONTROLLI_REGOLARI, --mc
           NULL AS NOTE_IRREGOLARITA, -- mc
           NULL AS   NOTE_IRREGOLARITA_PROVVISORIA, -- mc
           tec.NOTE AS NOTE_ESITO_REGOLARE --mc
      FROM --PBANDI_T_CAMPIONAMENTO tc,
           --PBANDI_R_CAMPIONAMENTO rc,
           PBANDI_T_PROGETTO tp,
           PBANDI_R_BANDO_LINEA_INTERVENT bli,
           PBANDI_T_DOMANDA td,
           PBANDI_T_PERIODO ptp,
           PBANDI_D_CATEG_ANAGRAFICA dca,
           PBANDI_R_SOGGETTO_PROGETTO rsp,
           PBANDI_T_ENTE_GIURIDICO teg,
           PBANDI_T_SOGGETTO ts,
           PBANDI_T_ESITO_CONTROLLI tec
     WHERE -- tc.ID_CAMPIONE = rc.ID_CAMPIONE
           -- AND rc.ID_PROGETTO = tp.ID_PROGETTO
           tp.ID_PROGETTO = tec.ID_PROGETTO -- mc
           AND tec.ID_PERIODO = ptp.ID_PERIODO
           AND tec.ID_CATEG_ANAGRAFICA = dca.ID_CATEG_ANAGRAFICA
           AND tec.ID_PROGETTO = rsp.ID_PROGETTO
           AND rsp.ID_ENTE_GIURIDICO = teg.ID_ENTE_GIURIDICO
           AND ts.ID_SOGGETTO = teg.id_SOGGETTO
           AND rsp.ID_TIPO_ANAGRAFICA = 1
           AND rsp.ID_TIPO_BENEFICIARIO <> 4
           AND tp.ID_DOMANDA = td.ID_DOMANDA
           AND td.PROGR_BANDO_LINEA_INTERVENTO =
                  bli.PROGR_BANDO_LINEA_INTERVENTO
           AND tec.id_progetto NOT IN (select ID_PROGETTO
                                       from pbandi_t_campionamento tc,
                                            pbandi_r_campionamento rc
                                       where tc.id_campione = rc.id_campione
                                       AND   tc.id_categ_anagrafica = tec.id_categ_anagrafica
                                       AND   tc.id_periodo = tec.id_periodo
                                       AND   tc.tipo_controlli = tec.tipo_controlli))
       UNION
       -- tutti i progetti senza esiti
       (SELECT DISTINCT
          -- 4 as n_query,
           ptp.ID_PERIODO,
           ptp.DESC_PERIODO_VISUALIZZATA,
           -- tc.ID_CAMPIONE,
           -- id normativa
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_NORMATIVA,
           -- normativa
           (    SELECT DESC_BREVE_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 1 --  NORMATIVA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              NORMATIVA,
           -- id asse
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_ASSE,
           --asse
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 2 --  ASSE LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ASSE,
           -- id misura
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_MISURA,
           --misura
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 3 --  MISURA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              MISURA,
           --id linea
           (    SELECT ID_LINEA_DI_INTERVENTO
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              ID_AZIONE,
           -- linea
           (    SELECT DESC_BREVE_LINEA || '-' || DESC_LINEA
                  FROM PBANDI_D_LINEA_DI_INTERVENTO
                 WHERE ID_TIPO_LINEA_INTERVENTO = 4 --  LINEA LEGATA AL PROGETTO
            CONNECT BY PRIOR id_linea_di_intervento_padre =
                          id_linea_di_intervento
            START WITH id_linea_di_intervento =
                          (SELECT c.id_linea_di_intervento
                             FROM PBANDI_T_PROGETTO a,
                                  PBANDI_T_DOMANDA b,
                                  PBANDI_R_BANDO_LINEA_INTERVENT c
                            WHERE a.id_progetto = rc.ID_PROGETTO
                                  AND b.id_domanda = a.id_domanda
                                  AND c.progr_bando_linea_intervento =
                                         b.progr_bando_linea_intervento))
              AZIONE,
           bli.PROGR_BANDO_LINEA_INTERVENTO,
           rc.ID_PROGETTO,
           bli.NOME_BANDO_LINEA,
           tp.CODICE_VISUALIZZATO,
           dca.ID_CATEG_ANAGRAFICA,
           dca.DESC_CATEG_ANAGRAFICA,
           teg.DENOMINAZIONE_ENTE_GIURIDICO,
           tc.DATA_CAMPIONAMENTO,
           tc.TIPO_CONTROLLI,
           NULL AS ID_IRREGOLARITA,
           NULL AS ID_IRREGOLARITA_COLLEG_PROVV,
           NULL AS DATA_INIZIO_CONTROLLI,
           NULL AS DATA_FINE_CONTROLLI,
           NULL AS ID_IRREGOLARITA_PROVV,
           NULL AS  DATA_INIZIO_CONTROLLI_PROVV,
           NULL AS DATA_FINE_CONTROLLI_PROVV,
           NULL AS  IRREGOLARITA_ANNULLATA_PROVV,
           NULL AS IMPORTO_IRREGOLARITA_PROVV,
           NULL AS  IMPORTO_AGEVOL_IRREG_PROVV,
           NULL AS  IMPORTO_IRREG_CERTIF_PROVV,
           NULL AS  DESC_MOTIVO_REVOCA_PROVV,
           NULL AS IMPORTO_IRREGOLARITA,
           NULL AS IMPORTO_AGEVOLAZIONE_IRREG,
           NULL AS QUOTA_IMP_IRREG_CERTIFICATO,
           NULL AS DESC_MOTIVO_REVOCA,
           NULL AS NUMERO_IMS,
           NULL AS TIPO_PROVVEDIMENTO,
           NULL AS ESTREMI,
           NULL AS IMPORTO,
           NULL AS IMPORTO_RECUPERO,
           NULL AS DATA_RECUPERO,
           NULL AS DESC_MANCATO_RECUPERO,
           NULL AS ID_ESITO_CONTROLLO,
           NULL AS DT_INIZIO_CONTROLLI_REGOLARI,
           NULL AS DT_FINE_CONTROLLI_REGOLARI,
           NULL AS NOTE_IRREGOLARITA,
           NULL AS NOTE_IRREGOLARITA_PROVVISORIA,
           NULL AS NOTE_ESITO_REGOLARE
      FROM PBANDI_T_CAMPIONAMENTO tc,
           PBANDI_R_CAMPIONAMENTO rc,
           PBANDI_T_PROGETTO tp,
           PBANDI_R_BANDO_LINEA_INTERVENT bli,
           PBANDI_T_DOMANDA td,
           PBANDI_T_PERIODO ptp,
           PBANDI_D_CATEG_ANAGRAFICA dca,
           PBANDI_R_SOGGETTO_PROGETTO rsp,
           PBANDI_T_ENTE_GIURIDICO teg,
           PBANDI_T_SOGGETTO ts
     WHERE  tc.ID_CAMPIONE = rc.ID_CAMPIONE
           AND rc.ID_PROGETTO = tp.ID_PROGETTO
           AND tc.ID_PERIODO = ptp.ID_PERIODO
           AND tc.ID_CATEG_ANAGRAFICA = dca.ID_CATEG_ANAGRAFICA
           AND tp.ID_PROGETTO = rsp.ID_PROGETTO
           AND rsp.ID_ENTE_GIURIDICO = teg.ID_ENTE_GIURIDICO
           AND ts.ID_SOGGETTO = teg.id_SOGGETTO
           AND rsp.ID_TIPO_ANAGRAFICA = 1
           AND rsp.ID_TIPO_BENEFICIARIO <> 4
           AND tp.ID_DOMANDA = td.ID_DOMANDA
           AND td.PROGR_BANDO_LINEA_INTERVENTO =
               bli.PROGR_BANDO_LINEA_INTERVENTO
           AND (rc.ID_PROGETTO NOT IN (SELECT rc1.ID_PROGETTO
                                      FROM   PBANDI_T_CAMPIONAMENTO tc1,
                                             PBANDI_R_CAMPIONAMENTO rc1,
                                             PBANDI_T_IRREGOLARITA_PROVV tip1
                                      WHERE
                                             tc1.id_campione = rc1.id_campione AND
                                             rc1.id_progetto = tip1.Id_Progetto
                                      AND    tc1.id_categ_anagrafica = tip1.id_categ_anagrafica
                                      AND    tc1.id_periodo = tip1.id_periodo
                                      AND    tc1.tipo_controlli = tip1.tipo_controlli)
                AND
                rc.ID_PROGETTO NOT IN (SELECT rc1.ID_PROGETTO
                                      FROM   PBANDI_T_CAMPIONAMENTO tc1,
                                             PBANDI_R_CAMPIONAMENTO rc1,
                                             PBANDI_T_IRREGOLARITA  ti1
                                      WHERE
                                             tc1.id_campione = rc1.id_campione AND
                                             rc1.id_progetto = ti1.Id_Progetto
                                      AND    tc1.id_categ_anagrafica = ti1.id_categ_anagrafica
                                      AND    tc1.id_periodo = ti1.id_periodo
                                      AND    tc1.tipo_controlli = ti1.tipo_controlli)
                 AND
                rc.ID_PROGETTO NOT IN (SELECT rc1.ID_PROGETTO
                                      FROM   PBANDI_T_CAMPIONAMENTO tc1,
                                             PBANDI_R_CAMPIONAMENTO rc1,
                                             PBANDI_T_ESITO_CONTROLLI tec1
                                      WHERE
                                             tc1.id_campione = rc1.id_campione AND
                                             rc1.id_progetto = tec1.Id_Progetto
                                      AND    tc1.id_categ_anagrafica = tec1.id_categ_anagrafica
                                      AND    tc1.id_periodo =          tec1.id_periodo
                                      AND    tc1.tipo_controlli =      tec1.tipo_controlli))));


